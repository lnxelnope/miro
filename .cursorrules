# Miro ‚Äî Cursor Rules (Project-specific Skills & Conventions)

## Language
- Always respond in Thai (‡πÑ‡∏ó‡∏¢).

---

## üî¥ CRITICAL: Food / Nutrition Data ‚Äî Consistent Pattern Across ALL Screens

‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö food/nutrition ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏° pattern ‡∏ô‡∏µ‡πâ **‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î**:

### 1. Search From DB First (‡∏Ñ‡πâ‡∏ô‡∏à‡∏≤‡∏Å Database ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠)
- ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‚Üí ‡∏Ñ‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö:
  1. **My Meals** (‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô) ‚Üí `allMyMealsProvider`
  2. **Ingredients** (‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß) ‚Üí `allIngredientsProvider`
  3. **Thai Food Database** (‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ó‡∏¢) ‚Üí `ThaiFoodDatabase.search()`
- ‡πÉ‡∏ä‡πâ `Autocomplete` widget ‡∏û‡∏£‡πâ‡∏≠‡∏° fuzzy search (contains)
- ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö ‚Üí ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏Å‡∏î Gemini ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á

### 2. Auto-fill Serving + Nutrition (‡πÄ‡∏ï‡∏¥‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì + ‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
- ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å DB ‚Üí auto-fill ‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á:
  - **‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì** (serving size) ‚Äî ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å DB (‡πÄ‡∏ä‡πà‡∏ô 16 ‡∏•‡∏π‡∏Å, 1 ‡∏à‡∏≤‡∏ô)
  - **‡∏´‡∏ô‡πà‡∏ß‡∏¢** (serving unit) ‚Äî ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å DB (‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏π‡∏Å, ‡∏à‡∏≤‡∏ô, ‡∏Å‡∏£‡∏±‡∏°)
  - **‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà** (kcal) ‚Äî ‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å DB
  - **Macro nutrients** (protein, carbs, fat) ‚Äî ‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å DB

### 3. ‚ö° MUST: Base Values Per Unit + Recalculate on Change
- **‡πÄ‡∏Å‡πá‡∏ö base values per 1 unit ‡πÄ‡∏™‡∏°‡∏≠:**
  ```dart
  _baseCalories = totalCalories / servingSize;  // kcal ‡∏ï‡πà‡∏≠ 1 ‡∏´‡∏ô‡πà‡∏ß‡∏¢
  _baseProtein  = totalProtein  / servingSize;
  _baseCarbs    = totalCarbs    / servingSize;
  _baseFat      = totalFat      / servingSize;
  ```
- **‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì ‚Üí recalculate ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥:**
  ```dart
  kcal = _baseCalories * newServingSize;
  protein = _baseProtein * newServingSize;
  carbs = _baseCarbs * newServingSize;
  fat = _baseFat * newServingSize;
  ```
- **‡∏ä‡πà‡∏≠‡∏á nutrition ‡∏ï‡πâ‡∏≠‡∏á `readOnly: true`** ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ base values (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
- **Listener ‡∏ï‡πâ‡∏≠‡∏á addListener ‡∏ó‡∏µ‡πà ServingSize controller** ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà initState
- **‡∏õ‡∏¥‡∏î listener ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß** ‡∏ï‡∏≠‡∏ô auto-fill (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ trigger ‡∏ã‡πâ‡∏≠‡∏ô)

### 4. FoodEntry Model ‚Äî Always Store Base Values
- ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å `FoodEntry` ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö:
  - `baseCalories`, `baseProtein`, `baseCarbs`, `baseFat` (‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≠ 1 ‡∏´‡∏ô‡πà‡∏ß‡∏¢)
  - `servingSize`, `servingUnit`
  - `calories`, `protein`, `carbs`, `fat` (‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°)

### 4.5 MyMeal Model ‚Äî baseServingDescription Parsing
- `MyMeal.baseServingDescription` ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô string ‡∏£‡∏ß‡∏° ‡πÄ‡∏ä‡πà‡∏ô "16 ‡∏•‡∏π‡∏Å", "1 ‡∏à‡∏≤‡∏ô"
- **‡∏´‡πâ‡∏≤‡∏°** hardcode `servingSize: 1` ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å MyMeal
- **‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ** helper getters:
  - `meal.parsedServingSize` ‚Üí 16 (double)
  - `meal.parsedServingUnit` ‚Üí "‡∏•‡∏π‡∏Å" (String)
  - `meal.caloriesPerUnit` ‚Üí kcal ‡∏ï‡πà‡∏≠ 1 ‡∏´‡∏ô‡πà‡∏ß‡∏¢
  - `meal.proteinPerUnit`, `meal.carbsPerUnit`, `meal.fatPerUnit`
- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏•‡∏π‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠ 450 kcal / 16 ‡∏•‡∏π‡∏Å ‚Üí caloriesPerUnit = 28.125

### 5. Screens That MUST Follow This Pattern
- `AddFoodBottomSheet` (health_diet_tab.dart) ‚Äî ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏ô Diet tab
- `EditFoodBottomSheet` (edit_food_bottom_sheet.dart) ‚Äî ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏≤‡∏´‡∏≤‡∏£
- `GeminiAnalysisSheet` (gemini_analysis_sheet.dart) ‚Äî ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Gemini
- `FoodDetailBottomSheet` (food_detail_bottom_sheet.dart) ‚Äî ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
- `CreateMealSheet` (create_meal_sheet.dart) ‚Äî ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π
- `IntentHandler` (intent_handler.dart) ‚Äî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏≤‡∏Å chat
- **‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà** ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï

### 6. Dropdown Unit ‚Äî Must Use `value:` Not `initialValue:`
- `DropdownButtonFormField` ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ `value: _servingUnit` ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà `initialValue:`
- ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ unit ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å DB

### 7. üåç Unit System ‚Äî Centralized via UnitConverter
- **Single source of truth**: `lib/core/utils/unit_converter.dart`
- **‡∏´‡πâ‡∏≤‡∏°** hardcode dropdown items ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ file ‚Äî ‡πÉ‡∏ä‡πâ `UnitConverter.allDropdownItems` ‡∏´‡∏£‡∏∑‡∏≠ `UnitConverter.compactDropdownItems`
- **‡∏´‡πâ‡∏≤‡∏°** hardcode unit validation ‚Äî ‡πÉ‡∏ä‡πâ `UnitConverter.ensureValid(unit)`
- **All unit keys are English**: `g`, `kg`, `lbs`, `oz`, `ml`, `l`, `cup`, `tbsp`, `tsp`, `fl oz`, `serving`, `piece`, `plate`, `bowl`, `glass`, `egg`, `ball`, etc.
- **‡∏´‡πâ‡∏≤‡∏°** ‡πÉ‡∏ä‡πâ Thai unit keys (‡∏à‡∏≤‡∏ô, ‡∏ñ‡πâ‡∏ß‡∏¢, ‡∏ä‡∏¥‡πâ‡∏ô, ‡∏•‡∏π‡∏Å...) ‡πÉ‡∏ô code ‡πÉ‡∏´‡∏°‡πà ‚Äî legacy Thai keys ‡∏ñ‡∏π‡∏Å resolve ‡∏ú‡πà‡∏≤‡∏ô `_legacyMap` ‡πÉ‡∏ô UnitConverter

### 8. üîÑ Unit Conversion on Unit Change
- ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô g ‚Üí lbs):
  - **Weight ‚Üî Weight** ‡∏´‡∏£‡∏∑‡∏≠ **Volume ‚Üî Volume**: ‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (kcal ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°, base per unit ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
  - **‡∏Ç‡πâ‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó** (‡πÄ‡∏ä‡πà‡∏ô g ‚Üí piece): ‡πÑ‡∏°‡πà‡πÅ‡∏õ‡∏•‡∏á ‚Äî keep ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÄ‡∏î‡∏¥‡∏°
- ‡πÉ‡∏ä‡πâ `UnitConverter.convertServing()` ‡πÄ‡∏û‡∏∑‡πà‡∏≠ handle ‡∏ó‡∏±‡πâ‡∏á 2 ‡∏Å‡∏£‡∏ì‡∏µ
- **Dropdown order**: Weight (‡∏ö‡∏ô) ‚Üí Volume ‚Üí Count ‚Üí Package (‡∏•‡πà‡∏≤‡∏á)

---

## General Conventions
- State management: **Riverpod** (`ConsumerStatefulWidget`, providers)
- Local DB: **Isar**
- AI: **Gemini API** (user BYOK)
- All food-related widgets should use `ConsumerStatefulWidget` for access to providers
- Always `ref.invalidate()` relevant providers after saving data
- Always check `mounted` before `setState` in async callbacks
