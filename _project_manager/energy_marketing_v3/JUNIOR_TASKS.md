# Junior Tasks ‚Äî ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢

> **‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö:** Junior Developer  
> **‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:** Implementation ‡∏ï‡∏≤‡∏° spec ‡∏ó‡∏µ‡πà Senior ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß  
> **‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å:** ‡∏á‡πà‡∏≤‡∏¢-‡∏Å‡∏•‡∏≤‡∏á, ‡∏°‡∏µ step-by-step ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î  
> **‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:** 20 ‡∏Å.‡∏û. 2026

---

## üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≤‡∏Å Codebase ‡∏à‡∏£‡∏¥‡∏á)

```
Phase 1 Config:           ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 100% (J1-J5 ‚úÖ)
Phase 2 Backend:          ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 100% (J6-J8 ‚úÖ)
Phase 3 Quest Bar:        ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë   0% (J9-J12 ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥)
Phase 3 Frontend Energy:  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 100% (J13-J16 ‚úÖ)
Phase 4 Admin Panel:      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  70% (J17-J18 üîß)

‡∏£‡∏ß‡∏°: ~80% ‡πÄ‡∏™‡∏£‡πá‡∏à
```

### ‡∏™‡∏£‡∏∏‡∏õ‡∏î‡πà‡∏ß‡∏ô ‚Äî ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏ô‡∏µ‡πâ!
| Task | ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ | ‡∏Ñ‡∏ô‡∏ó‡∏≥ |
|------|-------|------|
| ‚ùå J9: Quest Bar Countdown Timer | ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥ | Junior |
| ‚ùå J10: Quest Bar Swipe to Dismiss | ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥ | Junior |
| ‚ùå J11: Quest Bar ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° API | ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥ | Junior |
| ‚ùå J12: Quest Bar Referral Share | ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥ | Junior |
| üîß J17: Admin Analytics | ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ date filter) | Junior |
| üîß J18: Admin Push Campaign | ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ history log) | Junior |
| üîß Localization | ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Quest Bar keys ‡πÉ‡∏ô app_en.arb | Junior |

---

## ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°

‡∏á‡∏≤‡∏ô Junior ‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô 3 ‡∏Å‡∏•‡∏∏‡πà‡∏°:
1. **Config Changes** ‚Äî ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà (‡∏á‡πà‡∏≤‡∏¢‡∏°‡∏≤‡∏Å)
2. **Backend Implementation** ‚Äî ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô API ‡∏ï‡∏≤‡∏° spec ‡∏ó‡∏µ‡πà Senior ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß
3. **Frontend Implementation** ‚Äî ‡∏™‡∏£‡πâ‡∏≤‡∏á UI/UX ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà Senior ‡∏£‡∏∞‡∏ö‡∏∏

**‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£:** ‡∏ó‡∏∏‡∏Å task ‡∏°‡∏µ step ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î, ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏≠‡∏á, copy-paste ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢

---

## Phase 1: Config Changes ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

### J1. ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ Challenge Rewards ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à

**‡πÑ‡∏ü‡∏•‡πå:** `functions/src/energy/challenge.ts`

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**
1. ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå `functions/src/energy/challenge.ts`
2. ‡∏´‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ `CHALLENGE_REWARD`
3. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤:
   ```typescript
   // ‡πÄ‡∏î‡∏¥‡∏°
   const CHALLENGE_REWARD = 5;
   
   // ‡πÉ‡∏´‡∏°‡πà
   const CHALLENGE_REWARD = 3;
   ```
4. Save file
5. Deploy:
   ```bash
   firebase deploy --only functions:processChallenge
   ```

**Test:**
- ‡∏ó‡∏≥ challenge 1 ‡∏≠‡∏±‡∏ô ‚Üí ‡πÑ‡∏î‡πâ 3E (‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ 5E)

**Effort:** 10 ‡∏ô‡∏≤‡∏ó‡∏µ

---

### J2. ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ Tier Upgrade Rewards ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à

**‡πÑ‡∏ü‡∏•‡πå:** `functions/src/energy/dailyCheckIn.ts` (‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ tier reward logic)

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**
1. ‡∏´‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ `TIER_REWARDS` ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡πÜ
2. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤:
   ```typescript
   // ‡πÄ‡∏î‡∏¥‡∏°
   const TIER_REWARDS = {
     bronze: 3,
     silver: 5,
     gold: 10,
     diamond: 15,
   };
   
   // ‡πÉ‡∏´‡∏°‡πà
   const TIER_REWARDS = {
     bronze: 5,
     silver: 10,
     gold: 15,
     diamond: 25,
   };
   ```
3. Save + Deploy:
   ```bash
   firebase deploy --only functions:processDailyCheckIn
   ```

**Test:**
- Upgrade ‡πÑ‡∏õ Bronze ‚Üí ‡πÑ‡∏î‡πâ 5E
- Upgrade ‡πÑ‡∏õ Diamond ‚Üí ‡πÑ‡∏î‡πâ 25E

**Effort:** 10 ‡∏ô‡∏≤‡∏ó‡∏µ

---

### J3. ‡∏•‡∏ö Subscriber Double Quest Multiplier ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à

**‡πÑ‡∏ü‡∏•‡πå:** `functions/src/energy/challenge.ts`

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**
1. ‡∏´‡∏≤ logic ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ `if (user.isSubscriber)`
2. ‡∏´‡∏≤ code ‡∏ó‡∏µ‡πà‡∏Ñ‡∏π‡∏ì reward √ó 2
3. ‡∏•‡∏ö logic ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:
   ```typescript
   // ‡πÄ‡∏î‡∏¥‡∏°
   let reward = CHALLENGE_REWARD;
   if (user.subscription?.isActive) {
     reward *= 2; // ‚Üê ‡∏•‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
   }
   
   // ‡πÉ‡∏´‡∏°‡πà
   const reward = CHALLENGE_REWARD; // ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô
   ```
4. Save + Deploy

**Test:**
- Subscriber ‡∏ó‡∏≥ challenge ‚Üí ‡πÑ‡∏î‡πâ 3E (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤)

**Effort:** 15 ‡∏ô‡∏≤‡∏ó‡∏µ

---

### J4. ‡∏•‡∏ö Random Daily Bonus ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à

**‡πÑ‡∏ü‡∏•‡πå:** `functions/src/energy/dailyCheckIn.ts`

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**
1. ‡∏´‡∏≤ logic ‡∏ó‡∏µ‡πà‡∏°‡∏µ `Math.random()` ‡πÅ‡∏•‡∏∞ `5% chance`
2. ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:
   ```typescript
   // ‡πÄ‡∏î‡∏¥‡∏°
   let bonus = 0;
   if (Math.random() < 0.05) {
     bonus = Math.floor(Math.random() * 6) + 5; // 5-10E
   }
   // ... ‡πÄ‡∏û‡∏¥‡πà‡∏° bonus
   
   // ‡πÉ‡∏´‡∏°‡πà ‚Äî ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡∏°‡∏µ random bonus)
   ```
3. Save + Deploy

**Test:**
- Check-in 20 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚Üí ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÑ‡∏´‡∏ô‡πÑ‡∏î‡πâ bonus ‡πÄ‡∏û‡∏¥‡πà‡∏°

**Effort:** 15 ‡∏ô‡∏≤‡∏ó‡∏µ

---

### J5. ‡∏•‡∏ö First Empty Bonus (+50E) ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à

**‡πÑ‡∏ü‡∏•‡πå:** `functions/src/energy/` (‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ logic "energy ‡∏´‡∏°‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å")

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**
1. Search ‡πÉ‡∏ô functions/ ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "first empty" ‡∏´‡∏£‡∏∑‡∏≠ "firstEmptyBonus"
2. ‡∏´‡∏≤ code ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ `if (balance === 0 && !user.firstEmptyBonusClaimed)`
3. ‡∏•‡∏ö logic ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:
   ```typescript
   // ‡πÄ‡∏î‡∏¥‡∏°
   if (balance === 0 && !user.firstEmptyBonusClaimed) {
     await userRef.update({
       balance: 50,
       firstEmptyBonusClaimed: true,
     });
   }
   
   // ‡πÉ‡∏´‡∏°‡πà ‚Äî ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
   ```
4. Save + Deploy

**Test:**
- Energy ‡∏´‡∏°‡∏î (balance = 0) ‚Üí ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ +50E ‡∏ü‡∏£‡∏µ

**Effort:** 20 ‡∏ô‡∏≤‡∏ó‡∏µ

---

## Phase 2: Backend Implementation ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

### J6. Backend: Daily Claim (Manual) ‚Äî Endpoint ‡πÉ‡∏´‡∏°‡πà ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à

**‡πÑ‡∏ü‡∏•‡πå:** `functions/src/energy/claimDailyEnergy.ts` (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**

**Step 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà**
```typescript
import {onRequest} from 'firebase-functions/v2/https';
import * as admin from 'firebase-admin';

const db = admin.firestore();

export const claimDailyEnergy = onRequest({ cors: true }, async (req, res) => {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }
  
  try {
    const { deviceId } = req.body;
    
    if (!deviceId) {
      return res.status(400).json({ error: 'Missing deviceId' });
    }
    
    const userRef = db.collection('users').doc(deviceId);
    const userDoc = await userRef.get();
    
    if (!userDoc.exists) {
      return res.status(404).json({ error: 'User not found' });
    }
    
    const userData = userDoc.data()!;
    const today = new Date().toISOString().split('T')[0]; // 'YYYY-MM-DD'
    const lastClaimDate = userData.dailyClaim?.lastClaimDate || '';
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ claim ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    if (lastClaimDate === today) {
      return res.status(200).json({
        alreadyClaimed: true,
        message: 'Already claimed today',
      });
    }
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì energy ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ (‡∏ï‡∏≤‡∏° tier)
    const tier = userData.tier || 'starter';
    const dailyEnergy = {
      starter: 2,
      bronze: 3,
      silver: 4,
      gold: 5,
      diamond: 7,
    }[tier] || 2;
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° streak
    const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    let newStreak = userData.streak || 0;
    
    if (lastClaimDate === yesterday) {
      newStreak += 1; // ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
    } else if (lastClaimDate < yesterday) {
      newStreak = 1; // ‡∏Ç‡∏≤‡∏î‡∏ß‡∏±‡∏ô ‚Üí reset
    }
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ tier upgrade (‡∏ó‡∏∏‡∏Å 7 ‡∏ß‡∏±‡∏ô)
    let tierUpgraded = false;
    let newTier = tier;
    let tierReward = 0;
    
    if (newStreak % 7 === 0 && newStreak > 0) {
      const tierOrder = ['starter', 'bronze', 'silver', 'gold', 'diamond'];
      const currentIndex = tierOrder.indexOf(tier);
      if (currentIndex < tierOrder.length - 1) {
        newTier = tierOrder[currentIndex + 1];
        tierUpgraded = true;
        
        const tierRewards = { bronze: 5, silver: 10, gold: 15, diamond: 25 };
        tierReward = tierRewards[newTier as keyof typeof tierRewards] || 0;
      }
    }
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì energy ‡∏£‡∏ß‡∏°
    const totalEnergy = dailyEnergy + tierReward;
    const newBalance = userData.balance + totalEnergy;
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Firestore
    await userRef.update({
      balance: newBalance,
      streak: newStreak,
      tier: newTier,
      'dailyClaim.lastClaimDate': today,
      lastUpdated: admin.firestore.FieldValue.serverTimestamp(),
    });
    
    // Log transaction
    await db.collection('transactions').add({
      deviceId,
      type: 'daily_claim',
      amount: totalEnergy,
      balanceAfter: newBalance,
      description: `Daily claim: +${dailyEnergy}E (tier: ${tier})${tierUpgraded ? ` + Tier up reward: +${tierReward}E` : ''}`,
      metadata: {
        streak: newStreak,
        tierUpgraded,
        newTier: tierUpgraded ? newTier : null,
      },
      createdAt: admin.firestore.FieldValue.serverTimestamp(),
    });
    
    // ‡∏ñ‡πâ‡∏≤ tier upgrade ‚Üí ‡∏™‡πà‡∏á push notification
    if (tierUpgraded && userData.fcmToken) {
      await admin.messaging().send({
        token: userData.fcmToken,
        notification: {
          title: 'üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!',
          body: `‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô ${newTier}! Track calories ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å ‡∏´‡∏∏‡πà‡∏ô‡πÉ‡∏ô‡∏ù‡∏±‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡πâ‡∏ß!`,
        },
        data: {
          type: 'tier_up',
          newTier,
          reward: String(tierReward),
        },
      });
    }
    
    // ‡∏î‡∏∂‡∏á active offers (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö frontend ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Quest Bar)
    // TODO: call getActiveOffers(deviceId) ‡∏ó‡∏µ‡πà Senior ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ
    const activeOffers: any[] = []; // placeholder
    
    return res.status(200).json({
      success: true,
      energyClaimed: totalEnergy,
      newBalance,
      newStreak,
      tierUpgraded,
      newTier: tierUpgraded ? newTier : null,
      tierReward: tierUpgraded ? tierReward : 0,
      activeOffers,
    });
    
  } catch (error: any) {
    console.error('Error in claimDailyEnergy:', error);
    return res.status(500).json({ error: error.message });
  }
});
```

**Step 2: Export ‡πÉ‡∏ô index.ts**
```typescript
// functions/src/index.ts
export { claimDailyEnergy } from './energy/claimDailyEnergy';
```

**Step 3: Deploy**
```bash
firebase deploy --only functions:claimDailyEnergy
```

**Step 4: Test**
- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API:
  ```bash
  curl -X POST https://YOUR_REGION-YOUR_PROJECT.cloudfunctions.net/claimDailyEnergy \
    -H "Content-Type: application/json" \
    -d '{"deviceId": "test_device_123"}'
  ```
- Check response: `{ success: true, energyClaimed: 2, newBalance: xxx, ... }`
- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡πâ‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‚Üí `{ alreadyClaimed: true }`

**Effort:** 2-3 ‡∏ä‡∏°.

---

### J7. Backend: Referral Two-Way ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à

**‡πÑ‡∏ü‡∏•‡πå:** `functions/src/referral/checkReferralProgress.ts` (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**

**Step 1: ‡πÅ‡∏Å‡πâ logic ‡πÉ‡∏ô checkReferralProgress**
```typescript
// ‡πÄ‡∏î‡∏¥‡∏°: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ä‡∏ß‡∏ô‡πÑ‡∏î‡πâ reward
// ‡πÉ‡∏´‡∏°‡πà: ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢‡πÑ‡∏î‡πâ reward

export const checkReferralProgress = onCall(async (data, context) => {
  const { deviceId } = data;
  
  const userRef = db.collection('users').doc(deviceId);
  const userDoc = await userRef.get();
  
  if (!userDoc.exists) {
    throw new Error('User not found');
  }
  
  const userData = userDoc.data()!;
  const referredBy = userData.referredBy; // device ID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ä‡∏ß‡∏ô
  
  if (!referredBy) {
    return { eligible: false, reason: 'Not referred by anyone' };
  }
  
  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ Energy ‡∏Ñ‡∏£‡∏ö 10E ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
  const totalSpent = userData.milestones?.totalSpent || 0;
  
  if (totalSpent < 10) {
    return {
      eligible: false,
      reason: 'Need to spend 10E first',
      progress: totalSpent,
      target: 10,
    };
  }
  
  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ reward ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
  if (userData.referralRewardClaimed) {
    return { eligible: false, reason: 'Reward already claimed' };
  }
  
  // ‚úÖ ‡πÑ‡∏î‡πâ reward! ‚Äî ‡∏ó‡∏±‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏ä‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
  const REWARD = 5; // Energy
  
  // 1. ‡πÄ‡∏û‡∏¥‡πà‡∏° energy ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ä‡∏ß‡∏ô
  const referrerRef = db.collection('users').doc(referredBy);
  const referrerDoc = await referrerRef.get();
  
  if (referrerDoc.exists) {
    const referrerData = referrerDoc.data()!;
    const referrerNewBalance = referrerData.balance + REWARD;
    
    await referrerRef.update({
      balance: referrerNewBalance,
      lastUpdated: admin.firestore.FieldValue.serverTimestamp(),
    });
    
    // Log transaction (referrer)
    await db.collection('transactions').add({
      deviceId: referredBy,
      type: 'referral_reward',
      amount: REWARD,
      balanceAfter: referrerNewBalance,
      description: `Referral reward: friend spent 10E`,
      metadata: { friendDeviceId: deviceId },
      createdAt: admin.firestore.FieldValue.serverTimestamp(),
    });
  }
  
  // 2. ‡πÄ‡∏û‡∏¥‡πà‡∏° energy ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô (‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏ä‡∏ß‡∏ô)
  const friendNewBalance = userData.balance + REWARD;
  
  await userRef.update({
    balance: friendNewBalance,
    referralRewardClaimed: true,
    lastUpdated: admin.firestore.FieldValue.serverTimestamp(),
  });
  
  // Log transaction (friend)
  await db.collection('transactions').add({
    deviceId,
    type: 'referral_reward',
    amount: REWARD,
    balanceAfter: friendNewBalance,
    description: `Referral reward: you spent 10E`,
    metadata: { referrerDeviceId: referredBy },
    createdAt: admin.firestore.FieldValue.serverTimestamp(),
  });
  
  return {
    success: true,
    rewardGranted: REWARD,
    message: 'Both you and your friend received 5E!',
  };
});
```

**Step 2: Deploy**
```bash
firebase deploy --only functions:checkReferralProgress
```

**Step 3: Test**
- User A ‡∏ä‡∏ß‡∏ô User B
- User B ‡πÉ‡∏ä‡πâ Energy ‡∏Ñ‡∏£‡∏ö 10E
- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å `checkReferralProgress` ‚Üí User A ‡πÅ‡∏•‡∏∞ User B ‡πÑ‡∏î‡πâ +5E

**Effort:** 1-2 ‡∏ä‡∏°.

---

### J8. Backend: Winback Subscription Offer ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à

**‡πÑ‡∏ü‡∏•‡πå:** `functions/src/subscription/winbackScheduler.ts` (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**

**Step 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á scheduled function**
```typescript
import {onSchedule} from 'firebase-functions/v2/scheduler';
import * as admin from 'firebase-admin';

const db = admin.firestore();

export const winbackScheduler = onSchedule('every 24 hours', async () => {
  console.log('Running winback scheduler...');
  
  const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
  
  // Query: subscription expired > 7 ‡∏ß‡∏±‡∏ô && ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á winback
  const expiredUsers = await db.collection('users')
    .where('subscription.status', '==', 'expired')
    .where('subscription.expiryDate', '<', admin.firestore.Timestamp.fromDate(sevenDaysAgo))
    .where('winbackOfferAvailable', '==', false) // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á
    .limit(100)
    .get();
  
  for (const doc of expiredUsers.docs) {
    const user = doc.data();
    
    // Set winback flag
    const expiry = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000); // 7 ‡∏ß‡∏±‡∏ô
    await doc.ref.update({
      winbackOfferAvailable: true,
      winbackOfferExpiry: admin.firestore.Timestamp.fromDate(expiry),
      lastUpdated: admin.firestore.FieldValue.serverTimestamp(),
    });
    
    // ‡∏™‡πà‡∏á Push Notification
    if (user.fcmToken) {
      try {
        await admin.messaging().send({
          token: user.fcmToken,
          notification: {
            title: '‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ MiRO!',
            body: 'Energy Pass ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏£‡∏Å‡πÅ‡∏Ñ‡πà $3',
          },
          data: {
            type: 'winback_offer',
            offerId: 'winback-3usd',
          },
        });
        
        console.log(`Sent winback notification to ${doc.id}`);
      } catch (error) {
        console.error(`Failed to send notification to ${doc.id}:`, error);
      }
    }
  }
  
  console.log(`Processed ${expiredUsers.size} expired subscribers`);
});
```

**Step 2: Export + Deploy**
```typescript
// functions/src/index.ts
export { winbackScheduler } from './subscription/winbackScheduler';
```

```bash
firebase deploy --only functions:winbackScheduler
```

**Step 3: Test**
- ‡∏™‡∏£‡πâ‡∏≤‡∏á test user ‡∏ó‡∏µ‡πà subscription expired > 7 ‡∏ß‡∏±‡∏ô
- ‡∏£‡∏≠ 24 ‡∏ä‡∏°. (‡∏´‡∏£‡∏∑‡∏≠ manually trigger function)
- Check: `winbackOfferAvailable: true` + ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö push notification

**Effort:** 1-2 ‡∏ä‡∏°.

---

## Phase 3: Frontend Implementation (Sprint 3-5, ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà 3-5)

### J9. Frontend: Quest Bar - Countdown Timer ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥

**‡πÑ‡∏ü‡∏•‡πå:** `lib/features/energy/widgets/quest_bar.dart` (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**

**Step 1: ‡πÄ‡∏û‡∏¥‡πà‡∏° countdown timer**
```dart
import 'dart:async';

class _QuestBarState extends ConsumerState<QuestBar> {
  Timer? _countdownTimer;
  Duration? _remainingTime;

  @override
  void initState() {
    super.initState();
    _startCountdown();
  }

  @override
  void dispose() {
    _countdownTimer?.cancel();
    super.dispose();
  }

  void _startCountdown() {
    // TODO: ‡∏î‡∏∂‡∏á offer expiry ‡∏à‡∏≤‡∏Å server (activeOffers)
    // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ placeholder
    final expiryTime = DateTime.now().add(const Duration(hours: 4));
    
    _countdownTimer = Timer.periodic(const Duration(seconds: 1), (timer) {
      if (!mounted) {
        timer.cancel();
        return;
      }
      
      final now = DateTime.now();
      final remaining = expiryTime.difference(now);
      
      if (remaining.isNegative) {
        timer.cancel();
        setState(() => _remainingTime = null);
        // TODO: Refresh offers (offer ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß)
        // ref.read(gamificationProvider.notifier).refresh();
      } else {
        setState(() => _remainingTime = remaining);
      }
    });
  }

  String _formatDuration(Duration duration) {
    final hours = duration.inHours;
    final minutes = duration.inMinutes.remainder(60);
    final seconds = duration.inSeconds.remainder(60);
    
    return '${hours.toString().padLeft(2, '0')}:'
           '${minutes.toString().padLeft(2, '0')}:'
           '${seconds.toString().padLeft(2, '0')}';
  }

  @override
  Widget build(BuildContext context) {
    // ‡πÅ‡∏™‡∏î‡∏á countdown ‡πÉ‡∏ô offer row
    if (_remainingTime != null) {
      return Text(
        '‚è∞ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ ${_formatDuration(_remainingTime!)}',
        style: TextStyle(
          fontSize: 13,
          color: isDark ? AppColors.textSecondaryDark : AppColors.textSecondary,
        ),
      );
    }
    return const SizedBox.shrink();
  }
}
```

**Step 2: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö activeOffers**
```dart
// ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ activeOffers ‡∏à‡∏≤‡∏Å server
void _startCountdown() {
  if (_activeOffers.isEmpty) return;
  
  final firstOffer = _activeOffers.first;
  final expiryTimestamp = firstOffer['expiry']; // Timestamp ‡∏à‡∏≤‡∏Å server
  
  if (expiryTimestamp == null) return;
  
  // Convert Timestamp to DateTime
  final expiryTime = (expiryTimestamp as Timestamp).toDate();
  
  _countdownTimer = Timer.periodic(const Duration(seconds: 1), (timer) {
    // ... (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô code ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
  });
}
```

**Step 3: Test**
- ‡πÄ‡∏õ‡∏¥‡∏î Quest Bar ‚Üí ‡πÄ‡∏´‡πá‡∏ô countdown ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á
- ‡∏£‡∏≠ 1 ‡∏ô‡∏≤‡∏ó‡∏µ ‚Üí ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (HH:MM:SS)
- Mock expiry time = 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚Üí ‡πÄ‡∏´‡πá‡∏ô offer ‡∏´‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤

**Effort:** 2-3 ‡∏ä‡∏°.

---

### J10. Frontend: Quest Bar - Swipe to Dismiss Offer ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥

**‡πÑ‡∏ü‡∏•‡πå:** `lib/features/energy/widgets/quest_bar.dart` (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**

**Step 1: ‡πÉ‡∏ä‡πâ Dismissible widget**
```dart
Widget _buildOfferRow(BuildContext context, bool isDark) {
  final firstOffer = _activeOffers.first;
  final offerId = firstOffer['id'] as String;
  
  return Dismissible(
    key: Key('offer_$offerId'), // unique key per offer
    direction: DismissDirection.endToStart, // ‡∏õ‡∏±‡∏î‡∏ã‡πâ‡∏≤‡∏¢
    onDismissed: (direction) {
      // ‡∏ã‡πà‡∏≠‡∏ô offer
      setState(() => _dismissedOffers.add(offerId));
      
      // ‡πÅ‡∏™‡∏î‡∏á Snackbar (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô undo ‡∏•‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£)
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: const Text('Offer ‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô'),
          action: SnackBarAction(
            label: '‡∏î‡∏π Offer',
            onPressed: () {
              // Undo - ‡πÅ‡∏™‡∏î‡∏á offer ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
              setState(() => _dismissedOffers.remove(offerId));
            },
          ),
          duration: const Duration(days: 365), // ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏õ‡∏±‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
          behavior: SnackBarBehavior.floating,
        ),
      );
    },
    background: Container(
      alignment: Alignment.centerRight,
      padding: const EdgeInsets.only(right: 16),
      color: Colors.red.shade400,
      child: const Icon(Icons.delete_outline, color: Colors.white, size: 24),
    ),
    child: InkWell(
      onTap: () => setState(() => _isExpanded = !_isExpanded),
      borderRadius: BorderRadius.circular(12),
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        child: Row(
          children: [
            const Icon(Icons.local_fire_department_rounded, color: Colors.orange, size: 24),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    firstOffer['title'] ?? 'üî• Special Offer!',
                    style: TextStyle(
                      fontSize: 15,
                      fontWeight: FontWeight.bold,
                      color: isDark ? Colors.white : Colors.black87,
                    ),
                  ),
                  if (_remainingTime != null)
                    Text(
                      '‚è∞ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ ${_formatDuration(_remainingTime!)}',
                      style: TextStyle(
                        fontSize: 13,
                        color: isDark
                            ? AppColors.textSecondaryDark
                            : AppColors.textSecondary,
                      ),
                    ),
                ],
              ),
            ),
            Icon(
              _isExpanded ? Icons.expand_less : Icons.expand_more,
              color: isDark
                  ? AppColors.textSecondaryDark
                  : AppColors.textSecondary,
            ),
          ],
        ),
      ),
    ),
  );
}
```

**Step 2: ‡πÄ‡∏Å‡πá‡∏ö dismissed state**
```dart
class _QuestBarState extends ConsumerState<QuestBar> {
  final Set<String> _dismissedOffers = {}; // ‡πÄ‡∏Å‡πá‡∏ö offer ID ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô

  @override
  Widget build(BuildContext context) {
    // ‡∏Å‡∏£‡∏≠‡∏á offers ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å dismiss
    final activeOffers = _activeOffers
        .where((o) => !_dismissedOffers.contains(o['id']))
        .toList();
    
    if (activeOffers.isEmpty) {
      // ‡πÅ‡∏™‡∏î‡∏á Streak row ‡πÅ‡∏ó‡∏ô
      return _buildStreakRow(context, gamification, isDark);
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á offer row
    return _buildOfferRow(context, isDark);
  }
}
```

**Step 3: Test**
- ‡∏õ‡∏±‡∏î‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô offer ‚Üí offer ‡∏´‡∏≤‡∏¢ + Snackbar ‡∏õ‡∏£‡∏≤‡∏Å‡∏è
- ‡∏Å‡∏î "‡∏î‡∏π Offer" ‚Üí offer ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
- ‡∏õ‡∏±‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚Üí Snackbar ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà (‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢)

**Effort:** 3-4 ‡∏ä‡∏°.

---

### J11. Frontend: Quest Bar - Connect to API (canClaim & activeOffers) ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥

**‡πÑ‡∏ü‡∏•‡πå:** `lib/features/energy/widgets/quest_bar.dart` (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**

**Step 1: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å syncBalanceWithServer**
```dart
import '../../../core/services/energy_service.dart';
import '../../../core/database/database_service.dart';

class _QuestBarState extends ConsumerState<QuestBar> {
  bool _canClaim = false;
  int _claimableEnergy = 0;
  List<dynamic> _activeOffers = [];
  bool _isLoading = true;

  @override
  void initState() {
    super.initState();
    _loadData();
  }

  Future<void> _loadData() async {
    setState(() => _isLoading = true);
    
    try {
      final data = await EnergyService(DatabaseService.isar).syncBalanceWithServer();
      
      if (mounted) {
        final tier = data['tier'] as String? ?? 'starter';
        final energyMap = {
          'starter': 1,
          'bronze': 1,
          'silver': 2,
          'gold': 3,
          'diamond': 4,
        };
        
        setState(() {
          _canClaim = data['canClaimToday'] as bool? ?? false;
          _claimableEnergy = energyMap[tier] ?? 1;
          _activeOffers = data['activeOffers'] as List<dynamic>? ?? [];
          _isLoading = false;
        });
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏° countdown ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ offer
        if (_activeOffers.isNotEmpty) {
          _startCountdown();
        }
      }
    } catch (e) {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    if (_isLoading) {
      return Container(
        margin: const EdgeInsets.all(16),
        padding: const EdgeInsets.all(16),
        child: const Center(child: CircularProgressIndicator()),
      );
    }

    // ‡∏°‡∏µ Offer ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
    final activeOffers = _activeOffers
        .where((o) => !_dismissedOffers.contains(o['id']))
        .toList();
    final hasActiveOffer = activeOffers.isNotEmpty;
    
    if (hasActiveOffer) {
      return _buildOfferRow(context, isDark);
    } else {
      return _buildStreakRow(context, gamification, isDark);
    }
  }
}
```

**Step 2: ‡πÅ‡∏™‡∏î‡∏á active offers**
```dart
Widget _buildOfferRow(BuildContext context, bool isDark) {
  final firstOffer = _activeOffers.first;
  final title = firstOffer['title'] ?? 'üî• Special Offer!';
  final expiry = firstOffer['expiry']; // Timestamp
  
  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì countdown ‡∏à‡∏≤‡∏Å expiry
  // ... (‡πÉ‡∏ä‡πâ‡πÉ‡∏ô _startCountdown)
}
```

**Step 3: Test**
- ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ ‚Üí Quest Bar ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å server
- ‡∏°‡∏µ offer ‚Üí ‡πÅ‡∏™‡∏î‡∏á offer row ‡∏û‡∏£‡πâ‡∏≠‡∏° countdown
- ‡πÑ‡∏°‡πà‡∏°‡∏µ offer ‚Üí ‡πÅ‡∏™‡∏î‡∏á streak row

**Effort:** 2-3 ‡∏ä‡∏°.

---

### J12. Frontend: Quest Bar - Referral Share ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥

**‡πÑ‡∏ü‡∏•‡πå:** `lib/features/energy/widgets/quest_bar.dart` (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**

**Step 1: ‡πÄ‡∏û‡∏¥‡πà‡∏° dependency**
```yaml
# pubspec.yaml
dependencies:
  share_plus: ^7.0.0
```

```bash
flutter pub get
```

**Step 2: ‡∏™‡∏£‡πâ‡∏≤‡∏á referral share function**
```dart
import 'package:share_plus/share_plus.dart';
import '../../../core/services/device_id_service.dart';

Widget _buildReferralLink(BuildContext context, bool isDark) {
  return InkWell(
    onTap: () async {
      try {
        // ‡∏î‡∏∂‡∏á deviceId ‡∏Ç‡∏≠‡∏á user
        final deviceId = await DeviceIdService.getDeviceId();
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á referral link (dynamic link)
        // TODO: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Firebase Dynamic Links setup ‡∏Å‡πà‡∏≠‡∏ô
        // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ placeholder
        final referralLink = 'https://miro.app/ref/$deviceId';
        
        // ‡πÅ‡∏ä‡∏£‡πå
        await Share.share(
          '‡∏°‡∏≤‡∏•‡∏≠‡∏á‡πÅ‡∏≠‡∏õ MiRO ‡∏Å‡∏±‡∏ô! ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢ AI üçî\n'
          '‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ ‡πÄ‡∏£‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ +5 Energy ‡∏ü‡∏£‡∏µ!\n\n'
          '$referralLink',
          subject: '‡∏ä‡∏ß‡∏ô‡πÉ‡∏ä‡πâ MiRO',
        );
        
        // Log analytics
        // AnalyticsService.logReferralShare();
      } catch (e) {
        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: $e'),
              backgroundColor: Colors.red,
            ),
          );
        }
      }
    },
    borderRadius: BorderRadius.circular(8),
    child: Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
      decoration: BoxDecoration(
        color: isDark
            ? AppColors.primary.withOpacity(0.1)
            : AppColors.primary.withOpacity(0.05),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.primary.withOpacity(0.3)),
      ),
      child: Row(
        children: [
          const Icon(Icons.person_add_rounded, size: 18, color: AppColors.primary),
          const SizedBox(width: 8),
          Expanded(
            child: Text(
              'üë• ‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ 5E',
              style: TextStyle(
                fontSize: 14,
                fontWeight: FontWeight.w600,
                color: isDark ? Colors.white : Colors.black87,
              ),
            ),
          ),
          Icon(
            Icons.arrow_forward_ios,
            size: 14,
            color: isDark
                ? AppColors.textSecondaryDark
                : AppColors.textSecondary,
          ),
        ],
      ),
    ),
  );
}
```

**Step 3: Test**
- ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô" ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î share sheet
- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Line/Messenger ‚Üí ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏î‡πâ
- ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ (‡∏´‡∏£‡∏∑‡∏≠ Store)

**Effort:** 1-2 ‡∏ä‡∏°.

---

### J13. Frontend: Daily Claim Button + Confetti ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à

**‡πÑ‡∏ü‡∏•‡πå:** `lib/features/energy/widgets/claim_button.dart` (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**

**Step 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á widget**
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:confetti/confetti.dart';
import '../../../core/services/energy_service.dart';

class ClaimButton extends ConsumerStatefulWidget {
  final int claimableEnergy;

  const ClaimButton({
    super.key,
    required this.claimableEnergy,
  });

  @override
  ConsumerState<ClaimButton> createState() => _ClaimButtonState();
}

class _ClaimButtonState extends ConsumerState<ClaimButton> {
  late ConfettiController _confettiController;
  bool _isClaiming = false;

  @override
  void initState() {
    super.initState();
    _confettiController = ConfettiController(duration: const Duration(seconds: 2));
  }

  @override
  void dispose() {
    _confettiController.dispose();
    super.dispose();
  }

  Future<void> _handleClaim() async {
    if (_isClaiming) return;

    setState(() => _isClaiming = true);

    try {
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API claimDailyEnergy
      final result = await EnergyService.claimDailyEnergy();

      if (result['success'] == true) {
        // ‡πÅ‡∏™‡∏î‡∏á confetti
        _confettiController.play();

        // ‡πÅ‡∏™‡∏î‡∏á snackbar
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö +${result['energyClaimed']}E ‡πÅ‡∏•‡πâ‡∏ß!'),
              backgroundColor: Colors.green,
            ),
          );
        }

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ tier upgrade ‚Üí ‡πÅ‡∏™‡∏î‡∏á overlay
        if (result['tierUpgraded'] == true) {
          if (mounted) {
            showDialog(
              context: context,
              barrierDismissible: false,
              builder: (context) => TierUpOverlay(
                newTier: result['newTier'] as String,
                reward: result['tierReward'] as int,
                onDismiss: () => Navigator.of(context).pop(),
              ),
            );
          }
        }
      } else if (result['alreadyClaimed'] == true) {
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏•‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß'),
              backgroundColor: Colors.orange,
            ),
          );
        }
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() => _isClaiming = false);
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Stack(
      alignment: Alignment.center,
      children: [
        // Confetti
        ConfettiWidget(
          confettiController: _confettiController,
          blastDirection: -3.14 / 2, // ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô
          emissionFrequency: 0.05,
          numberOfParticles: 30,
          gravity: 0.3,
        ),

        // ‡∏õ‡∏∏‡πà‡∏° Claim
        GestureDetector(
          onTap: _isClaiming ? null : _handleClaim,
          child: Container(
            padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
            decoration: BoxDecoration(
              color: _isClaiming ? Colors.grey : Colors.green,
              borderRadius: BorderRadius.circular(20),
              boxShadow: [
                BoxShadow(
                  color: Colors.green.withOpacity(0.4),
                  blurRadius: 8,
                  offset: const Offset(0, 2),
                ),
              ],
            ),
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                const Icon(Icons.bolt, color: Colors.white, size: 16),
                const SizedBox(width: 4),
                Text(
                  '+${widget.claimableEnergy}E',
                  style: const TextStyle(
                    color: Colors.white,
                    fontWeight: FontWeight.bold,
                    fontSize: 14,
                  ),
                ),
                if (_isClaiming)
                  const SizedBox(
                    width: 12,
                    height: 12,
                    child: CircularProgressIndicator(
                      strokeWidth: 2,
                      color: Colors.white,
                    ),
                  ),
              ],
            ),
          ),
        ),
      ],
    );
  }
}
```

**Step 2: ‡πÄ‡∏û‡∏¥‡πà‡∏° dependency**
```yaml
# pubspec.yaml
dependencies:
  confetti: ^0.7.0
```

```bash
flutter pub get
```

**Step 3: ‡πÄ‡∏û‡∏¥‡πà‡∏° import TierUpOverlay**
```dart
// lib/features/energy/widgets/claim_button.dart
import '../widgets/tier_up_overlay.dart';
```

**Step 4: ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô Quest Bar**
```dart
// lib/features/energy/widgets/quest_bar.dart
if (_canClaim) {
  ClaimButton(
    claimableEnergy: _claimableEnergy,
    onClaimed: () => setState(() => _canClaim = false),
    onTierUp: () => _loadData(), // Refresh data after tier up
  ),
}
```

**Note:** ClaimButton ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ callback `onClaimed` ‡πÅ‡∏•‡∏∞ `onTierUp`:
```dart
class ClaimButton extends ConsumerStatefulWidget {
  final int claimableEnergy;
  final VoidCallback? onClaimed;
  final VoidCallback? onTierUp;

  const ClaimButton({
    super.key,
    required this.claimableEnergy,
    this.onClaimed,
    this.onTierUp,
  });
  
  // ‡πÉ‡∏ô _handleClaim ‡∏´‡∏•‡∏±‡∏á claim ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:
  widget.onClaimed?.call();
  if (result['tierUpgraded'] == true) {
    widget.onTierUp?.call();
  }
}
```

**Step 4: Test**
- ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Claim ‚Üí ‡πÄ‡∏´‡πá‡∏ô confetti 2 ‡∏ß‡∏¥ + snackbar
- ‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‚Üí ‡πÅ‡∏™‡∏î‡∏á "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏•‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß"

**Effort:** 2-3 ‡∏ä‡∏°.

---

### J14. Frontend: Tier Up Overlay ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à

**‡πÑ‡∏ü‡∏•‡πå:** `lib/features/energy/widgets/tier_up_overlay.dart` (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**

**Step 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á widget**
```dart
import 'package:flutter/material.dart';

class TierUpOverlay extends StatefulWidget {
  final String newTier;
  final int reward;
  final VoidCallback onDismiss;

  const TierUpOverlay({
    super.key,
    required this.newTier,
    required this.reward,
    required this.onDismiss,
  });

  @override
  State<TierUpOverlay> createState() => _TierUpOverlayState();
}

class _TierUpOverlayState extends State<TierUpOverlay>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scaleAnimation;
  late Animation<double> _fadeAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(seconds: 3),
      vsync: this,
    );

    _scaleAnimation = Tween<double>(begin: 0.5, end: 1.0).animate(
      CurvedAnimation(parent: _controller, curve: Curves.elasticOut),
    );

    _fadeAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(parent: _controller, curve: Curves.easeIn),
    );

    _controller.forward();

    // Auto-dismiss ‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥
    Future.delayed(const Duration(seconds: 3), () {
      if (mounted) {
        widget.onDismiss();
      }
    });
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  String _getTierIcon(String tier) {
    const icons = {
      'bronze': 'ü•â',
      'silver': 'ü•à',
      'gold': 'ü•á',
      'diamond': 'üíé',
    };
    return icons[tier] ?? '‚≠ê';
  }

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: widget.onDismiss,
      child: Container(
        color: Colors.black.withOpacity(0.8),
        child: Center(
          child: FadeTransition(
            opacity: _fadeAnimation,
            child: ScaleTransition(
              scale: _scaleAnimation,
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  // Tier icon
                  Text(
                    _getTierIcon(widget.newTier),
                    style: const TextStyle(fontSize: 100),
                  ),
                  const SizedBox(height: 16),

                  // ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢
                  const Text(
                    'üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 32,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 8),

                  // Tier name
                  Text(
                    '‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô ${widget.newTier.toUpperCase()}!',
                    style: const TextStyle(
                      color: Colors.white,
                      fontSize: 24,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                  const SizedBox(height: 16),

                  // Motivation text
                  const Text(
                    'Track calories ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å\n‡∏´‡∏∏‡πà‡∏ô‡πÉ‡∏ô‡∏ù‡∏±‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡πâ‡∏ß!',
                    textAlign: TextAlign.center,
                    style: TextStyle(
                      color: Colors.white70,
                      fontSize: 16,
                    ),
                  ),
                  const SizedBox(height: 24),

                  // Reward
                  Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 24,
                      vertical: 12,
                    ),
                    decoration: BoxDecoration(
                      color: Colors.amber,
                      borderRadius: BorderRadius.circular(30),
                    ),
                    child: Text(
                      '+${widget.reward}E Reward!',
                      style: const TextStyle(
                        color: Colors.black,
                        fontSize: 24,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}
```

**Step 2: ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á Claim**
```dart
// lib/features/energy/widgets/claim_button.dart
if (result['tierUpgraded'] == true) {
  showDialog(
    context: context,
    barrierDismissible: false,
    builder: (context) => TierUpOverlay(
      newTier: result['newTier'],
      reward: result['tierReward'],
      onDismiss: () => Navigator.of(context).pop(),
    ),
  );
}
```

**Step 3: Test**
- Claim ‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏£‡∏ö 7 ‡∏ß‡∏±‡∏ô ‚Üí ‡πÄ‡∏´‡πá‡∏ô overlay + animation
- Tap anywhere ‚Üí dismiss

**Effort:** 2-3 ‡∏ä‡∏°.

---

### J15. Frontend: Rewarded Ads (AdMob) Integration ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à

**‡πÑ‡∏ü‡∏•‡πå:** `lib/core/services/ad_service.dart` (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**

**Step 1: ‡πÄ‡∏û‡∏¥‡πà‡∏° dependency**
```yaml
# pubspec.yaml
dependencies:
  google_mobile_ads: ^5.0.0
```

```bash
flutter pub get
```

**Step 2: Config AndroidManifest.xml**
```xml
<!-- android/app/src/main/AndroidManifest.xml -->
<manifest>
  <application>
    <meta-data
      android:name="com.google.android.gms.ads.APPLICATION_ID"
      android:value="ca-app-pub-6145254112451474~9703380291"/>
  </application>
</manifest>
```

**Step 3: ‡∏™‡∏£‡πâ‡∏≤‡∏á AdService**
```dart
import 'package:google_mobile_ads/google_mobile_ads.dart';
import 'package:flutter/foundation.dart';

class AdService {
  static const String _rewardedAdUnitId = 'ca-app-pub-6145254112451474/4582480782';
  
  RewardedAd? _rewardedAd;
  int _adsWatchedToday = 0;
  static const int maxAdsPerDay = 3;

  bool get canWatchAd => _adsWatchedToday < maxAdsPerDay;
  int get remainingAds => maxAdsPerDay - _adsWatchedToday;

  Future<void> initialize() async {
    await MobileAds.instance.initialize();
    await _loadRewardedAd();
  }

  Future<void> _loadRewardedAd() async {
    await RewardedAd.load(
      adUnitId: _rewardedAdUnitId,
      request: const AdRequest(),
      rewardedAdLoadCallback: RewardedAdLoadCallback(
        onAdLoaded: (ad) {
          debugPrint('‚úÖ Rewarded ad loaded');
          _rewardedAd = ad;
        },
        onAdFailedToLoad: (error) {
          debugPrint('‚ùå Rewarded ad failed to load: $error');
          _rewardedAd = null;
        },
      ),
    );
  }

  Future<bool> showRewardedAd() async {
    if (_rewardedAd == null) {
      debugPrint('‚ö†Ô∏è Rewarded ad not loaded yet');
      return false;
    }

    if (!canWatchAd) {
      debugPrint('‚ö†Ô∏è Daily ad limit reached');
      return false;
    }

    bool adWatched = false;

    _rewardedAd!.fullScreenContentCallback = FullScreenContentCallback(
      onAdDismissedFullScreenContent: (ad) {
        debugPrint('Ad dismissed');
        ad.dispose();
        _loadRewardedAd(); // Preload next ad
      },
      onAdFailedToShowFullScreenContent: (ad, error) {
        debugPrint('‚ùå Ad failed to show: $error');
        ad.dispose();
        _loadRewardedAd();
      },
    );

    await _rewardedAd!.show(
      onUserEarnedReward: (ad, reward) {
        debugPrint('‚úÖ User earned reward: ${reward.amount}');
        _adsWatchedToday++;
        adWatched = true;
      },
    );

    _rewardedAd = null;
    return adWatched;
  }

  void dispose() {
    _rewardedAd?.dispose();
  }
}
```

**Step 4: ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Analyze**
```dart
// lib/features/camera/presentation/camera_screen.dart
final adService = AdService();

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Energy = 0
ElevatedButton(
  onPressed: () async {
    final success = await adService.showRewardedAd();
    
    if (success) {
      // ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ AI ‡∏ü‡∏£‡∏µ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      await analyzeFood(isFreeFromAd: true);
    } else {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà'),
        ),
      );
    }
  },
  child: Text('üì∫ ‡∏î‡∏π‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ü‡∏£‡∏µ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${adService.remainingAds}/3)'),
)
```

**Step 5: Test**
- Energy = 0 ‚Üí ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π ad
- ‡∏î‡∏π‡∏à‡∏ö ‚Üí ‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ AI ‡∏ü‡∏£‡∏µ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
- ‡∏î‡∏π 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚Üí ‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô

**Effort:** 3-4 ‡∏ä‡∏°.

---

### J16. Frontend: Subscription Plans UI (3 Plans) ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à

**‡πÑ‡∏ü‡∏•‡πå:** `lib/features/subscription/presentation/subscription_screen.dart` (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**

**Step 1: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI**
```dart
// ‡πÅ‡∏™‡∏î‡∏á 3 plans ‡πÅ‡∏ó‡∏ô 1 plan
ListView(
  children: [
    // Weekly
    _buildPlanCard(
      title: 'Weekly',
      price: '\$1.99',
      period: 'week',
      isRecommended: false,
    ),

    // Monthly (recommended)
    _buildPlanCard(
      title: 'Monthly',
      price: '\$4.99',
      period: 'month',
      isRecommended: true,
      badge: 'BEST VALUE',
      savings: '‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î 42%',
    ),

    // Yearly
    _buildPlanCard(
      title: 'Yearly',
      price: '\$39.99',
      period: 'year',
      isRecommended: false,
      savings: '‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î 62% ‚Äî ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ \$3.33/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
    ),
  ],
)

Widget _buildPlanCard({
  required String title,
  required String price,
  required String period,
  bool isRecommended = false,
  String? badge,
  String? savings,
}) {
  return Container(
    margin: const EdgeInsets.symmetric(vertical: 8),
    padding: const EdgeInsets.all(16),
    decoration: BoxDecoration(
      border: Border.all(
        color: isRecommended ? Colors.orange : Colors.grey,
        width: isRecommended ? 3 : 1,
      ),
      borderRadius: BorderRadius.circular(12),
    ),
    child: Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(
              title,
              style: const TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.bold,
              ),
            ),
            if (badge != null)
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                decoration: BoxDecoration(
                  color: Colors.orange,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Text(
                  badge,
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 10,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
          ],
        ),
        const SizedBox(height: 4),
        Text(
          '$price/$period',
          style: const TextStyle(fontSize: 16, color: Colors.grey),
        ),
        if (savings != null)
          Text(
            savings,
            style: const TextStyle(fontSize: 14, color: Colors.green),
          ),
      ],
    ),
  );
}
```

**Step 2: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° IAP**
```dart
// ‡πÉ‡∏ä‡πâ SubscriptionPlan model ‡∏ó‡∏µ‡πà Senior ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ
final plans = SubscriptionPlan.availablePlans();

for (final plan in plans) {
  _buildPlanCard(
    title: plan.name,
    price: plan.price,
    period: plan.period,
    isRecommended: plan.isPopular,
    savings: plan.savingsText,
  );
}
```

**Step 3: Test**
- ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Subscription ‚Üí ‡πÄ‡∏´‡πá‡∏ô 3 plans
- Monthly ‡∏°‡∏µ badge "BEST VALUE"
- Yearly ‡πÅ‡∏™‡∏î‡∏á savings

**Effort:** 2-3 ‡∏ä‡∏°.

---

## Phase 4: Admin Panel (Sprint 5-6, ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà 5-6)

### J17. Admin: Promotion Conversion Rate Page üîß ‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô

**‡πÑ‡∏ü‡∏•‡πå:** `admin-panel/pages/dashboard/analytics/promotions.tsx` (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**

**Step 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á page**
```tsx
import { useState, useEffect } from 'react';
import { collection, query, where, getDocs } from 'firebase/firestore';
import { db } from '@/lib/firebase';

interface PromotionStats {
  name: string;
  timesShown: number;
  purchased: number;
  conversionRate: number;
  revenue: number;
}

export default function PromotionsPage() {
  const [stats, setStats] = useState<PromotionStats[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchPromotionStats();
  }, []);

  async function fetchPromotionStats() {
    setLoading(true);

    // Query transactions ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô promotion
    const q = query(
      collection(db, 'transactions'),
      where('type', 'in', ['first_purchase', 'bonus_40', 'tier_promo'])
    );

    const snapshot = await getDocs(q);
    
    // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô purchase ‡∏ï‡πà‡∏≠ promotion
    const statsMap: Record<string, { purchased: number; revenue: number }> = {};
    
    snapshot.forEach((doc) => {
      const data = doc.data();
      const promoType = data.type;
      
      if (!statsMap[promoType]) {
        statsMap[promoType] = { purchased: 0, revenue: 0 };
      }
      
      statsMap[promoType].purchased += 1;
      statsMap[promoType].revenue += data.metadata?.price || 0;
    });

    // TODO: Query "times shown" ‡∏à‡∏≤‡∏Å analytics events (‡∏´‡∏£‡∏∑‡∏≠ hardcode ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)
    const promotions: PromotionStats[] = [
      {
        name: '$1 = 200E',
        timesShown: 1234, // TODO: get from analytics
        purchased: statsMap['first_purchase']?.purchased || 0,
        conversionRate: 0,
        revenue: statsMap['first_purchase']?.revenue || 0,
      },
      {
        name: '40% Bonus',
        timesShown: 456,
        purchased: statsMap['bonus_40']?.purchased || 0,
        conversionRate: 0,
        revenue: statsMap['bonus_40']?.revenue || 0,
      },
      // ... tier promos
    ];

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì conversion rate
    promotions.forEach((p) => {
      p.conversionRate = p.timesShown > 0 ? (p.purchased / p.timesShown) * 100 : 0;
    });

    setStats(promotions);
    setLoading(false);
  }

  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold mb-4">Promotion Conversion Rate</h1>

      {loading ? (
        <p>Loading...</p>
      ) : (
        <table className="w-full border">
          <thead>
            <tr className="bg-gray-100">
              <th className="border p-2">Promotion</th>
              <th className="border p-2">Times Shown</th>
              <th className="border p-2">Purchased</th>
              <th className="border p-2">Conversion %</th>
              <th className="border p-2">Revenue</th>
            </tr>
          </thead>
          <tbody>
            {stats.map((stat) => (
              <tr key={stat.name}>
                <td className="border p-2">{stat.name}</td>
                <td className="border p-2">{stat.timesShown.toLocaleString()}</td>
                <td className="border p-2">{stat.purchased.toLocaleString()}</td>
                <td className="border p-2">{stat.conversionRate.toFixed(1)}%</td>
                <td className="border p-2">${stat.revenue.toFixed(2)}</td>
              </tr>
            ))}
          </tbody>
        </table>
      )}
    </div>
  );
}
```

**Step 2: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÉ‡∏ô sidebar**
```tsx
// admin-panel/components/Sidebar.tsx
<Link href="/dashboard/analytics/promotions">
  Promotion Conversion
</Link>
```

**Step 3: Test**
- ‡πÄ‡∏õ‡∏¥‡∏î `/dashboard/analytics/promotions`
- ‡πÄ‡∏´‡πá‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á + conversion rate

**Effort:** 3-4 ‡∏ä‡∏°.

---

### J18. Admin: Push Notification Campaign üîß ‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô

**‡πÑ‡∏ü‡∏•‡πå:** `admin-panel/pages/dashboard/campaigns/push.tsx` (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**

**Step 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ UI**
```tsx
import { useState } from 'react';

export default function PushCampaignPage() {
  const [title, setTitle] = useState('');
  const [body, setBody] = useState('');
  const [sending, setSending] = useState(false);

  async function sendPushNotification() {
    setSending(true);

    try {
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Cloud Function
      const response = await fetch(
        'https://YOUR_REGION-YOUR_PROJECT.cloudfunctions.net/sendBulkPushNotification',
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title,
            body,
            targetSegment: 'all', // ‡∏´‡∏£‡∏∑‡∏≠ filter ‡∏ï‡∏≤‡∏° tier/subscription
          }),
        }
      );

      const result = await response.json();
      alert(`Sent to ${result.sentCount} users`);
    } catch (error) {
      alert(`Error: ${error}`);
    } finally {
      setSending(false);
    }
  }

  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold mb-4">Push Notification Campaign</h1>

      <div className="space-y-4">
        <div>
          <label className="block mb-2">Title</label>
          <input
            type="text"
            className="border p-2 w-full"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            placeholder="e.g., üéâ Flash Sale!"
          />
        </div>

        <div>
          <label className="block mb-2">Body</label>
          <textarea
            className="border p-2 w-full"
            rows={4}
            value={body}
            onChange={(e) => setBody(e.target.value)}
            placeholder="e.g., Get 50% off all Energy packages for the next 24 hours!"
          />
        </div>

        <button
          className="bg-blue-500 text-white px-4 py-2 rounded disabled:bg-gray-300"
          onClick={sendPushNotification}
          disabled={sending || !title || !body}
        >
          {sending ? 'Sending...' : 'Send to All Users'}
        </button>
      </div>
    </div>
  );
}
```

**Step 2: ‡∏™‡∏£‡πâ‡∏≤‡∏á Cloud Function (sendBulkPushNotification)**
```typescript
// functions/src/admin/sendBulkPushNotification.ts
export const sendBulkPushNotification = onRequest(async (req, res) => {
  const { title, body, targetSegment } = req.body;

  // Query users (all ‡∏´‡∏£‡∏∑‡∏≠ filtered)
  let usersQuery = db.collection('users');

  if (targetSegment === 'subscribers') {
    usersQuery = usersQuery.where('subscription.status', '==', 'active');
  }

  const snapshot = await usersQuery.limit(1000).get();
  const tokens: string[] = [];

  snapshot.forEach((doc) => {
    const fcmToken = doc.data().fcmToken;
    if (fcmToken) tokens.push(fcmToken);
  });

  // Send multicast
  const result = await admin.messaging().sendEachForMulticast({
    tokens,
    notification: { title, body },
  });

  res.json({ sentCount: result.successCount, failedCount: result.failureCount });
});
```

**Step 3: Deploy + Test**
```bash
firebase deploy --only functions:sendBulkPushNotification
```

- ‡∏Å‡∏£‡∏≠‡∏Å title/body ‚Üí Send
- Check: users ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö notification

**Effort:** 3-4 ‡∏ä‡∏°.

---

## ‡∏™‡∏£‡∏∏‡∏õ Timeline (Junior) ‚Äî ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï 20 ‡∏Å.‡∏û. 2026

| Phase | ‡∏á‡∏≤‡∏ô | ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ | Effort |
|-------|-----|-------|--------|
| Config | J1-J5 | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß | 1-2 ‡∏ß‡∏±‡∏ô |
| Backend | J6-J8 | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß | 4-6 ‡∏ß‡∏±‡∏ô |
| Frontend Quest Bar | J9-J12 | ‚ùå **‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥** | 3-4 ‡∏ß‡∏±‡∏ô |
| Frontend Energy | J13-J16 | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß | 8-10 ‡∏ß‡∏±‡∏ô |
| Admin Panel | J17-J18 | üîß ‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô | 2-3 ‡∏ß‡∏±‡∏ô |

### üéØ ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ï‡πà‡∏≠ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ~4-6 ‡∏ß‡∏±‡∏ô)

**‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:**
1. ‚ùå **J9-J12: Quest Bar Enhancement** (~3-4 ‡∏ß‡∏±‡∏ô) ‚Äî backend API (S3) ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!
   - J9: Countdown Timer
   - J10: Swipe to Dismiss Offer
   - J11: Connect to API (canClaim & activeOffers)
   - J12: Referral Share
2. üîß **J17: Admin Analytics** (~0.5 ‡∏ß‡∏±‡∏ô) ‚Äî ‡πÄ‡∏û‡∏¥‡πà‡∏° date filter
3. üîß **J18: Admin Push Campaign** (~0.5 ‡∏ß‡∏±‡∏ô) ‚Äî ‡πÄ‡∏û‡∏¥‡πà‡∏° history log
4. üîß **Localization** (~0.5 ‡∏ß‡∏±‡∏ô) ‚Äî ‡πÄ‡∏û‡∏¥‡πà‡∏° Quest Bar keys ‡πÉ‡∏ô `app_en.arb` / `app_th.arb`

### ‚úÖ ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (14/18 tasks)
- ‚úÖ J1-J5: Config Changes (‡∏Ñ‡∏£‡∏ö)
- ‚úÖ J6-J8: Backend (‡∏Ñ‡∏£‡∏ö)
- ‚úÖ J13-J16: Frontend Energy (‡∏Ñ‡∏£‡∏ö)
- ‚úÖ Quest Bar Widget ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à (`quest_bar.dart`)
- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Timeline ‡πÅ‡∏•‡πâ‡∏ß
- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á Streak + Progress Bar + Collapsible section

---

## Tips ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Junior

1. **‡∏ó‡∏≥‡∏ï‡∏≤‡∏° step-by-step** ‚Äî ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏≠‡∏á ‡πÅ‡∏Ñ‡πà copy code ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏£‡∏±‡∏ö
2. **Test ‡∏ó‡∏∏‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô** ‚Äî ‡∏≠‡∏¢‡πà‡∏≤‡∏£‡∏≠‡∏ñ‡∏∂‡∏á deploy ‡∏Ñ‡πà‡∏≠‡∏¢ test
3. **‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤** ‚Äî ‡∏ñ‡∏≤‡∏° Senior ‡∏û‡∏£‡πâ‡∏≠‡∏° error message + screenshot
4. **Commit ‡∏ö‡πà‡∏≠‡∏¢‡πÜ** ‚Äî ‡∏ó‡∏∏‡∏Å task ‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à commit ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
5. **‡∏≠‡πà‡∏≤‡∏ô comment ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î** ‚Äî Senior ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à logic
