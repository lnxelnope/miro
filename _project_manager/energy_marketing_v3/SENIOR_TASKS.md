# Senior Tasks ‚Äî ‡∏á‡∏≤‡∏ô‡∏¢‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡∏°‡∏≠‡∏á

> **‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö:** Senior Developer  
> **‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:** Architecture, Design, Critical Logic, Code Review  
> **Timeline:** ‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô/‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö Junior  
> **‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:** 20 ‡∏Å.‡∏û. 2026

---

## üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≤‡∏Å Codebase ‡∏à‡∏£‡∏¥‡∏á)

```
Setup & Architecture:   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 100% (S0-S3 ‚úÖ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
Critical Logic:         ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 100% (S4-S6 ‚úÖ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
Review & Integration:   ‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  20% (S7-S8 ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥)
Performance/Security:   ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë   0% (S9-S11 ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥)

‡∏£‡∏ß‡∏°: ~75% ‡πÄ‡∏™‡∏£‡πá‡∏à
```

### ‡∏™‡∏£‡∏∏‡∏õ‡∏î‡πà‡∏ß‡∏ô
| Task | ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ | ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ |
|------|-------|----------|
| S0 Quest Bar Widget | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à | UI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à, ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Timeline ‡πÅ‡∏•‡πâ‡∏ß |
| S1 Firestore Schema | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à | `_docs/FIRESTORE_SCHEMA_V3.md` ‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö |
| S2 Milestone V2 | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à | `milestoneV2.ts` ‚Äî 10 ‡∏Ç‡∏±‡πâ‡∏ô + ‡∏™‡∏π‡∏ï‡∏£ cashback |
| S3 Offer System | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à | `offersV2.ts` ‚Äî getActiveOffers + dismissOffer |
| S4 Bug Fix ‡∏ã‡∏∑‡πâ‡∏≠‡∏ã‡πâ‡∏≥ | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à | `verifyPurchase.ts` + `promotions.ts` |
| S5 Rewarded Ads SSV | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à | `rewardedAd.ts` ‚Äî signature verification |
| S6 Push Notifications | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à | `pushTriggers.ts` ‚Äî 3 triggers |
| S7 Code Review | ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥ | PR template + checklist |
| S8 Quest Bar Tests | ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥ | Integration tests |
| S9 Performance | ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥ | Optimization |
| S10 Security Audit | ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥ | Firestore rules, input validation |
| S11 Migration | ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥ | Staged rollout plan |

### üî¥ ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏î‡πà‡∏ß‡∏ô (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Quest Bar ‡∏Å‡∏±‡∏ö Backend)
Quest Bar Widget ‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° API:
- `quest_bar.dart` ‚Üí `hasActiveOffer = false` (hard-code)
- ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö `offersV2.ts` ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (Junior J11)

---

## ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°

‡∏á‡∏≤‡∏ô Senior ‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô 3 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:
1. **Setup & Architecture** ‚Äî ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà Junior ‡∏à‡∏∞‡πÉ‡∏ä‡πâ
2. **Critical Logic** ‚Äî Logic ‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≠ Revenue/Security
3. **Review & Integration** ‚Äî Review code, Integration testing

---

## Phase 0: Setup & Architecture (‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà 1)

### S0. ‡∏™‡∏£‡πâ‡∏≤‡∏á Quest Bar Widget ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à

**‡πÑ‡∏ü‡∏•‡πå:** `lib/features/energy/widgets/quest_bar.dart`

**‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‚úÖ Senior ‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏£‡∏≠ Junior ‡∏ó‡∏≥‡∏ï‡πà‡∏≠ (J9-J12)**

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à:**
- ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Quest Bar widget ‡∏û‡∏£‡πâ‡∏≠‡∏° 2 states (Offer / Streak)
- ‚úÖ Collapsible section ‡πÅ‡∏™‡∏î‡∏á Offers, Challenges, Milestones, Referral
- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° `compact` parameter ‡πÉ‡∏´‡πâ WeeklyChallengeCard ‡πÅ‡∏•‡∏∞ MilestoneProgressCard
- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Quest Bar ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Timeline (HealthTimelineTab)

**üîµ ‡∏á‡∏≤‡∏ô Junior ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ï‡πà‡∏≠ (J9-J12):**
- üî≤ J9: Countdown Timer
- üî≤ J10: Swipe to Dismiss
- üî≤ J11: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° API `getActiveOffers()` (backend ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô S3)
- üî≤ J12: Referral Share

---

### S1. ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Firestore Schema ‡πÉ‡∏´‡∏°‡πà ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à

**‡πÑ‡∏ü‡∏•‡πå:** `_docs/FIRESTORE_SCHEMA_V3.md` ‚úÖ ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**
```typescript
// users/{deviceId}
{
  // ‚îÄ‚îÄ‚îÄ‚îÄ Existing Fields (‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞) ‚îÄ‚îÄ‚îÄ‚îÄ
  balance: number,
  tier: string,
  streak: number,
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ NEW: Offers Tracking ‚îÄ‚îÄ‚îÄ‚îÄ
  offers: {
    // 1-time purchase offers
    firstPurchaseClaimed: boolean,          // $1 = 200E deal
    firstPurchaseAvailable: boolean,        // trigger flag
    firstPurchaseExpiry: Timestamp | null,  // expiry time (4 hours)
    
    // Bonus offers
    welcomeBonusClaimed: boolean,           // 40% bonus (‡∏´‡∏•‡∏±‡∏á $1 deal)
    welcomeBonusAvailable: boolean,
    welcomeBonusExpiry: Timestamp | null,   // expiry time (24 hours)
    
    // Tier upgrade promos (20% bonus ‡∏ï‡∏≠‡∏ô tier up)
    tierPromoClaimed: {
      bronze: boolean,
      silver: boolean,
      gold: boolean,
      diamond: boolean,
    },
    tierPromoActive: {
      tier: string | null,                  // 'bronze' | 'silver' | ...
      expiry: Timestamp | null,             // 24 hours
    },
  },
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ NEW: Milestones (10 ‡∏Ç‡∏±‡πâ‡∏ô) ‚îÄ‚îÄ‚îÄ‚îÄ
  milestones: {
    totalSpent: number,                     // cumulative energy spent
    claimedMilestones: string[],            // ['milestone_10', 'milestone_25', ...]
    nextMilestoneIndex: number,             // index in MILESTONES array
  },
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ NEW: Rewarded Ads ‚îÄ‚îÄ‚îÄ‚îÄ
  adViews: {
    date: string,                           // 'YYYY-MM-DD'
    count: number,                          // 0-3
  },
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ NEW: Daily Claim (Manual) ‚îÄ‚îÄ‚îÄ‚îÄ
  dailyClaim: {
    lastClaimDate: string,                  // 'YYYY-MM-DD'
    canClaim: boolean,                      // computed field (optional)
  },
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ NEW: Push Notifications ‚îÄ‚îÄ‚îÄ‚îÄ
  fcmToken: string | null,
  notifications: {
    offerExpirySent: {                      // track ‡∏ß‡πà‡∏≤‡∏™‡πà‡∏á push ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö offer ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß
      [offerId: string]: boolean,           // e.g. { 'first_purchase_abc': true }
    },
    lastStreakReminder: string,             // 'YYYY-MM-DD' (‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
  },
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ NEW: Subscription (Base Plan ID) ‚îÄ‚îÄ‚îÄ‚îÄ
  subscription: {
    status: 'active' | 'expired' | 'cancelled' | 'grace_period',
    productId: string,                      // 'miro_normal_subscription'
    basePlanId: string,                     // 'energy-pass-monthly' | 'energy-pass-weekly' | 'energy-pass-yearly'
    offerId: string | null,                 // 'first-month-free' | 'winback-3usd' | null
    purchaseToken: string,
    startDate: Timestamp,
    expiryDate: Timestamp,
    autoRenewing: boolean,
    lastVerifiedAt: Timestamp,
  },
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ NEW: Winback Flag ‚îÄ‚îÄ‚îÄ‚îÄ
  winbackOfferAvailable: boolean,
  winbackOfferExpiry: Timestamp | null,
}
```

**Decision points (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à):**
- Offer ID format: random string ‡∏´‡∏£‡∏∑‡∏≠ predictable? (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: random uuid)
- Expiry: store ‡πÄ‡∏õ‡πá‡∏ô Timestamp ‡∏´‡∏£‡∏∑‡∏≠ duration + created? (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: Timestamp ‡πÄ‡∏û‡∏∑‡πà‡∏≠ query ‡∏á‡πà‡∏≤‡∏¢)
- Notification tracking: store ‡πÉ‡∏ô user doc ‡∏´‡∏£‡∏∑‡∏≠ separate collection? (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÉ‡∏ô user doc ‡∏ñ‡πâ‡∏≤ < 100 offers)

**Output:**
- ‚úÖ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ `_docs/FIRESTORE_SCHEMA_V3.md`
- ‚úÖ ER diagram (‡πÉ‡∏ä‡πâ Mermaid ‡∏´‡∏£‡∏∑‡∏≠ draw.io)
- ‚úÖ Migration script: `scripts/migrateUsersToV3.ts`
- ‚úÖ Rollback script (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏à‡∏≠ error)

**Timeline:** 4-6 ‡∏ä‡∏°.

---

### S2. ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Milestone System + ‡∏™‡∏π‡∏ï‡∏£ Cashback ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à

**‡πÑ‡∏ü‡∏•‡πå:** `functions/src/energy/milestoneV2.ts` ‚úÖ ‡∏°‡∏µ 10 ‡∏Ç‡∏±‡πâ‡∏ô + ‡∏™‡∏π‡∏ï‡∏£ cashback

**‡∏™‡∏π‡∏ï‡∏£ Diminishing Cashback:**
```
Cashback % = Base √ó (1 - log‚ÇÅ‚ÇÄ(threshold) / k)
```

**‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à:**
1. ‡∏Ñ‡πà‡∏≤ Base ‡πÅ‡∏•‡∏∞ k ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ cashback curve ‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á
2. ‡∏à‡∏∞ hardcode milestone table ‡∏´‡∏£‡∏∑‡∏≠ dynamic config ‡∏à‡∏≤‡∏Å Firestore?
   - **Hardcode:** fast, simple, ‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£ (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ Phase 1)
   - **Dynamic:** flexible, ‡∏ï‡πâ‡∏≠‡∏á admin panel ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ (‡∏ó‡∏≥‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á Phase 5)
3. Migration: existing users ‡∏ó‡∏µ‡πà totalSpent > 0 ‚Üí map ‡πÑ‡∏õ‡∏¢‡∏±‡∏á milestone index ‡πÑ‡∏´‡∏ô?

**Logic ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô:**
```typescript
// ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡πà‡∏≤ user ‡∏Ñ‡∏ß‡∏£‡∏≠‡∏¢‡∏π‡πà milestone ‡πÑ‡∏´‡∏ô‡∏ï‡∏≤‡∏° totalSpent
function computeMilestoneState(totalSpent: number): {
  claimedMilestones: string[];
  nextMilestoneIndex: number;
}

// ‡πÄ‡∏ä‡πá‡∏Ñ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏∏‡∏Å AI analysis
async function checkMilestoneProgress(deviceId: string, newTotalSpent: number): Promise<{
  milestoneReached: boolean;
  milestoneLabel: string | null;
  reward: number;
  nextMilestone: { threshold: number; reward: number; } | null;
}>
```

**‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ Implementation:**

```typescript
// functions/src/energy/milestoneV2.ts

const MILESTONES = [
  { threshold: 10, reward: 3, cashback: 0.30 },
  { threshold: 25, reward: 5, cashback: 0.20 },
  { threshold: 50, reward: 7, cashback: 0.14 },
  { threshold: 100, reward: 10, cashback: 0.10 },
  { threshold: 250, reward: 15, cashback: 0.06 },
  { threshold: 500, reward: 20, cashback: 0.04 },
  { threshold: 1000, reward: 30, cashback: 0.03 },
  { threshold: 2500, reward: 50, cashback: 0.02 },
  { threshold: 5000, reward: 65, cashback: 0.013 },
  { threshold: 10000, reward: 100, cashback: 0.01 },
];

function computeMilestoneState(totalSpent: number) {
  const claimedMilestones: string[] = [];
  let nextMilestoneIndex = 0;
  
  for (let i = 0; i < MILESTONES.length; i++) {
    if (totalSpent >= MILESTONES[i].threshold) {
      claimedMilestones.push(`milestone_${MILESTONES[i].threshold}`);
      nextMilestoneIndex = i + 1;
    } else {
      break;
    }
  }
  
  return { claimedMilestones, nextMilestoneIndex };
}

async function checkMilestoneProgress(deviceId: string, newTotalSpent: number) {
  const userRef = db.collection('users').doc(deviceId);
  const userData = (await userRef.get()).data();
  
  const currentIndex = userData.milestones?.nextMilestoneIndex || 0;
  
  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô milestone ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  if (currentIndex < MILESTONES.length) {
    const nextMilestone = MILESTONES[currentIndex];
    
    if (newTotalSpent >= nextMilestone.threshold) {
      // ‚úÖ ‡∏ú‡πà‡∏≤‡∏ô milestone!
      const reward = nextMilestone.reward;
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° energy
      await userRef.update({
        balance: admin.firestore.FieldValue.increment(reward),
        'milestones.totalSpent': newTotalSpent,
        'milestones.claimedMilestones': admin.firestore.FieldValue.arrayUnion(
          `milestone_${nextMilestone.threshold}`
        ),
        'milestones.nextMilestoneIndex': currentIndex + 1,
      });
      
      return {
        milestoneReached: true,
        milestoneLabel: `${nextMilestone.threshold}E spent`,
        reward,
        nextMilestone: MILESTONES[currentIndex + 1] || null,
      };
    }
  }
  
  return {
    milestoneReached: false,
    milestoneLabel: null,
    reward: 0,
    nextMilestone: MILESTONES[currentIndex] || null,
  };
}
```

**Output:**
- ‚úÖ `functions/src/energy/milestoneV2.ts` (logic + MILESTONES array)
- ‚úÖ Unit tests: `milestoneV2.test.ts`
- ‚úÖ Migration script: `scripts/migrateMilestones.ts`

**Timeline:** 1 ‡∏ß‡∏±‡∏ô

---

### S3. ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Offer Flow + Expiry System ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à

**Complexity:** ‡∏™‡∏π‡∏á ‚Äî ‡∏ï‡πâ‡∏≠‡∏á handle:
- Multiple offers ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
- Expiry time
- 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ö‡∏±‡∏ç‡∏ä‡∏µ validation
- Priority (offer ‡πÑ‡∏´‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Å‡πà‡∏≠‡∏ô)
- **Integration ‡∏Å‡∏±‡∏ö Quest Bar** (Frontend ‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏∂‡∏á offers ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á)

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö:**

```typescript
// Offer priority (‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ô‡∏µ‡πâ)
enum OfferPriority {
  FIRST_PURCHASE = 1,    // $1 = 200E (4hr) ‚Äî urgent
  BONUS_40 = 2,          // 40% bonus (24hr) ‚Äî ‡∏´‡∏•‡∏±‡∏á $1
  TIER_PROMO = 3,        // Tier upgrade 20% (24hr)
  WINBACK = 4,           // Ex-subscriber winback
  SUB_UPSELL = 5,        // Milestone 50E ‚Üí subscribe
}

interface OfferData {
  id: string;            // unique ID
  type: string;          // 'first_purchase' | 'bonus_40' | 'tier_promo' | 'winback' | 'sub_upsell'
  priority: number;
  title: string;         // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Quest Bar
  description: string;
  expiry: Timestamp | null;
  metadata: any;         // offer-specific data (e.g., productId, discount%)
}

// ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô:
async function getActiveOffers(deviceId: string): Promise<OfferData[]>
async function dismissOffer(deviceId: string, offerId: string): Promise<void>
async function claimOffer(deviceId: string, offerId: string): Promise<boolean>
```

**üî¥ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:** Quest Bar ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å `getActiveOffers()` ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ
- ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡πá‡∏ß (< 500ms)
- ‡∏ï‡πâ‡∏≠‡∏á sort by priority
- ‡∏ï‡πâ‡∏≠‡∏á filter offers ‡∏ó‡∏µ‡πà expired/claimed ‡∏≠‡∏≠‡∏Å

**Decision points:**
- Dismissed offer: ‡∏ã‡πà‡∏≠‡∏ô‡∏ñ‡∏≤‡∏ß‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô list (‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏î‡∏π‡πÄ‡∏≠‡∏á)?
  ‚Üí **‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:** ‡πÄ‡∏Å‡πá‡∏ö dismissed state ‡πÉ‡∏ô user doc (`dismissedOffers: string[]`)
- Expiry: check ‡πÄ‡∏°‡∏∑‡πà‡∏≠ query ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ cron job ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå?
  ‚Üí **‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:** Check realtime ‡πÄ‡∏°‡∏∑‡πà‡∏≠ query (filter `where expiry > now`)
- Offer ID: random uuid ‡∏´‡∏£‡∏∑‡∏≠ `${type}_${timestamp}`?
  ‚Üí **‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:** `${type}_${userId}_${timestamp}` (unique + traceable)

**‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ Implementation:**

```typescript
// functions/src/energy/offersV2.ts

export const getActiveOffers = onRequest({ cors: true }, async (req, res) => {
  try {
    const { deviceId } = req.body;
    
    const userRef = db.collection('users').doc(deviceId);
    const userData = (await userRef.get()).data();
    
    if (!userData) {
      return res.status(404).json({ error: 'User not found' });
    }
    
    const now = admin.firestore.Timestamp.now();
    const offers: OfferData[] = [];
    
    // 1. First Purchase Offer ($1 = 200E)
    if (
      userData.offers?.firstPurchaseAvailable &&
      !userData.offers?.firstPurchaseClaimed &&
      userData.offers?.firstPurchaseExpiry?.toMillis() > now.toMillis()
    ) {
      offers.push({
        id: `first_purchase_${deviceId}`,
        type: 'first_purchase',
        priority: 1,
        title: 'üî• 200E ‡πÅ‡∏Ñ‡πà $1!',
        description: 'First purchase special deal',
        expiry: userData.offers.firstPurchaseExpiry,
        metadata: {
          productId: 'energy_200_first_purchase',
          discount: 0.60,
        },
      });
    }
    
    // 2. 40% Bonus Offer (‡∏´‡∏•‡∏±‡∏á‡∏ã‡∏∑‡πâ‡∏≠ $1)
    if (
      userData.offers?.welcomeBonusAvailable &&
      !userData.offers?.welcomeBonusClaimed &&
      userData.offers?.welcomeBonusExpiry?.toMillis() > now.toMillis()
    ) {
      offers.push({
        id: `bonus_40_${deviceId}`,
        type: 'bonus_40',
        priority: 2,
        title: '40% Bonus Energy',
        description: 'Get 40% extra on all purchases',
        expiry: userData.offers.welcomeBonusExpiry,
        metadata: {
          bonusRate: 0.40,
        },
      });
    }
    
    // 3. Tier Promo (20% bonus ‡∏ï‡∏≠‡∏ô tier up)
    if (
      userData.offers?.tierPromoActive?.tier &&
      userData.offers?.tierPromoActive?.expiry?.toMillis() > now.toMillis()
    ) {
      const tier = userData.offers.tierPromoActive.tier;
      offers.push({
        id: `tier_promo_${tier}_${deviceId}`,
        type: 'tier_promo',
        priority: 3,
        title: `${tier.toUpperCase()} Tier Promo`,
        description: '20% bonus energy',
        expiry: userData.offers.tierPromoActive.expiry,
        metadata: {
          tier,
          bonusRate: 0.20,
        },
      });
    }
    
    // Sort by priority (lowest number = highest priority)
    offers.sort((a, b) => a.priority - b.priority);
    
    return res.status(200).json({
      success: true,
      offers,
      count: offers.length,
    });
    
  } catch (error: any) {
    console.error('Error in getActiveOffers:', error);
    return res.status(500).json({ error: error.message });
  }
});
```

**Output:**
- ‚úÖ `functions/src/energy/offersV2.ts` (3 endpoints: getActiveOffers, dismissOffer, claimOffer)
- ‚úÖ Unit tests: `offersV2.test.ts`
- ‚úÖ Integration test: Quest Bar ‡πÅ‡∏™‡∏î‡∏á offer ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á + countdown update realtime
- ‚úÖ Performance test: < 500ms response time

**Timeline:** 1-2 ‡∏ß‡∏±‡∏ô (üî¥ CRITICAL - ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô Junior ‡∏ó‡∏≥ J9-J12)

---

## Phase 1: Critical Logic (‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà 1-2)

### S4. ‡πÅ‡∏Å‡πâ Bug: Offer ‡∏ã‡∏∑‡πâ‡∏≠‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à

**‡πÑ‡∏ü‡∏•‡πå:** `functions/src/subscription/verifyPurchase.ts`, `functions/src/energy/promotions.ts`

**‡∏õ‡∏±‡∏ç‡∏´‡∏≤:**
- Welcome Offer, Tier Promo ‡∏ã‡∏∑‡πâ‡∏≠‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ
- ‡πÑ‡∏°‡πà‡∏°‡∏µ server-side validation

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
1. ‡∏Å‡πà‡∏≠‡∏ô process purchase:
   ```typescript
   const userData = await db.collection('users').doc(deviceId).get();
   const offers = userData.data()?.offers || {};
   
   // ‡πÄ‡∏ä‡πá‡∏Ñ productId ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô offer ‡πÑ‡∏´‡∏ô
   if (isWelcomeOffer(productId) && offers.welcomeBonusClaimed) {
     throw new Error('Offer already claimed');
   }
   
   if (isTierPromo(productId, metadata)) {
     const tier = metadata.tier;
     if (offers.tierPromoClaimed?.[tier]) {
       throw new Error(`Tier promo for ${tier} already claimed`);
     }
   }
   ```

2. ‡∏´‡∏•‡∏±‡∏á verify purchase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:
   ```typescript
   await userRef.update({
     'offers.welcomeBonusClaimed': true,
     // ‡∏´‡∏£‡∏∑‡∏≠
     [`offers.tierPromoClaimed.${tier}`]: true,
   });
   ```

3. Frontend: ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° (‡πÉ‡∏ä‡πâ `offers` state ‡∏à‡∏≤‡∏Å Firestore)

**Testing:**
- ‡∏ã‡∏∑‡πâ‡∏≠ offer ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‚Üí success
- ‡∏ã‡∏∑‡πâ‡∏≠‡∏ã‡πâ‡∏≥ ‚Üí rejected (error code 409)
- ‡∏•‡∏≠‡∏á‡∏à‡∏≤‡∏Å device ‡∏≠‡∏∑‡πà‡∏ô same account ‚Üí rejected

**Priority:** üî¥ ‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å ‚Äî ‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á

---

### S5. ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Rewarded Ads Server-Side Verification (SSV) ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à

**‡πÑ‡∏ü‡∏•‡πå:** `functions/src/energy/rewardedAd.ts` ‚úÖ ‡∏°‡∏µ signature verification

**Complexity:** Google AdMob SSV ‡∏ï‡πâ‡∏≠‡∏á verify signature

**‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥:**
1. ‡πÉ‡∏ô AdMob Console ‚Üí ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Server-Side Verification URL:
   ```
   https://us-central1-miro-d6856.cloudfunctions.net/verifyRewardedAd?deviceId={DEVICE_ID}
   ```

2. Backend endpoint:
   ```typescript
   export const verifyRewardedAd = onRequest(async (req, res) => {
     // 1. ‡∏£‡∏±‡∏ö query params ‡∏à‡∏≤‡∏Å AdMob
     const { signature, key_id, ad_network, reward_amount, timestamp } = req.query;
     const deviceId = req.query.deviceId as string;
     
     // 2. Verify signature (‡πÉ‡∏ä‡πâ public key ‡∏à‡∏≤‡∏Å AdMob)
     const isValid = verifyAdMobSignature(signature, key_id, { ad_network, reward_amount, timestamp });
     
     if (!isValid) {
       return res.status(403).json({ error: 'Invalid signature' });
     }
     
     // 3. Check quota (max 3/‡∏ß‡∏±‡∏ô)
     const userRef = db.collection('users').doc(deviceId);
     const userData = await userRef.get();
     const adViews = userData.data()?.adViews || { date: '', count: 0 };
     const today = new Date().toISOString().split('T')[0];
     
     if (adViews.date === today && adViews.count >= 3) {
       return res.status(429).json({ error: 'Daily limit reached' });
     }
     
     // 4. Update count (‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° balance ‚Äî frontend ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ AI ‡∏ü‡∏£‡∏µ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)
     const newCount = adViews.date === today ? adViews.count + 1 : 1;
     await userRef.update({
       'adViews.date': today,
       'adViews.count': newCount,
     });
     
     // 5. Log transaction
     await db.collection('transactions').add({
       deviceId,
       type: 'ad_reward',
       amount: 0,
       description: 'Rewarded ad viewed',
       createdAt: admin.firestore.FieldValue.serverTimestamp(),
     });
     
     res.status(200).json({ success: true, remainingAds: 3 - newCount });
   });
   ```

3. Security:
   - Verify AdMob signature (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô fake requests)
   - Rate limit: max 3/day/user
   - IP whitelist: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ AdMob servers (optional)

**Helper Function: Verify AdMob Signature**
```typescript
import * as crypto from 'crypto';

// Google AdMob Public Keys (download ‡∏à‡∏≤‡∏Å AdMob Console)
const ADMOB_PUBLIC_KEYS: Record<string, string> = {
  // key_id: public_key_pem
  '3335741209': '-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqh...\n-----END PUBLIC KEY-----',
};

function verifyAdMobSignature(
  signature: string,
  keyId: string,
  params: Record<string, any>
): boolean {
  const publicKey = ADMOB_PUBLIC_KEYS[keyId];
  if (!publicKey) {
    console.error(`Unknown key_id: ${keyId}`);
    return false;
  }
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á query string ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö verify (‡∏ï‡πâ‡∏≠‡∏á sort alphabetically)
  const sortedParams = Object.keys(params)
    .sort()
    .map((key) => `${key}=${params[key]}`)
    .join('&');
  
  // Verify signature
  const verifier = crypto.createVerify('SHA256');
  verifier.update(sortedParams);
  
  return verifier.verify(publicKey, signature, 'base64');
}
```

**Output:**
- ‚úÖ `functions/src/energy/rewardedAd.ts` (verifyRewardedAd endpoint)
- ‚úÖ Signature verification function
- ‚úÖ Unit tests: mock AdMob callback + signature
- ‚úÖ Integration test: ‡∏î‡∏π ad ‡∏à‡∏£‡∏¥‡∏á ‚Üí verify ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à

**Timeline:** 1 ‡∏ß‡∏±‡∏ô

---

### S6. ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Push Notification Triggers ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à

**‡πÑ‡∏ü‡∏•‡πå:** `functions/src/notifications/pushTriggers.ts` ‚úÖ ‡∏°‡∏µ 3 triggers (offerExpiry, streakReminder, tierUp)

**3 ‡∏Å‡∏£‡∏ì‡∏µ:**

#### 6.1 Offer Expiry (15 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡∏•‡∏∞ loop)
```typescript
export const checkOfferExpiry = onSchedule('every 15 minutes', async () => {
  // Query users ‡∏ó‡∏µ‡πà‡∏°‡∏µ active offer ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ < 1 hour
  const oneHourFromNow = admin.firestore.Timestamp.fromDate(
    new Date(Date.now() + 60 * 60 * 1000)
  );
  
  const usersWithExpiringSoon = await db.collection('users')
    .where('offers.firstPurchaseAvailable', '==', true)
    .where('offers.firstPurchaseExpiry', '<=', oneHourFromNow)
    .where('notifications.offerExpirySent.first_purchase', '==', false)
    .limit(100)
    .get();
  
  for (const doc of usersWithExpiringSoon.docs) {
    const user = doc.data();
    if (!user.fcmToken) continue;
    
    await admin.messaging().send({
      token: user.fcmToken,
      notification: {
        title: '‚è∞ ‡πÇ‡∏õ‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏´‡∏°‡∏î!',
        body: '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏µ‡∏Å 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á',
      },
      data: {
        type: 'offer_expiry',
        offerId: 'first_purchase',
      },
    });
    
    // Mark as sent
    await doc.ref.update({
      'notifications.offerExpirySent.first_purchase': true,
    });
  }
});
```

#### 6.2 Streak Reminder (‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô 21:00 UTC+7)
```typescript
export const streakReminder = onSchedule('0 21 * * *', { timeZone: 'Asia/Bangkok' }, async () => {
  const today = new Date().toISOString().split('T')[0];
  
  // Query users ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà claim ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ + streak > 0
  const users = await db.collection('users')
    .where('dailyClaim.lastClaimDate', '!=', today)
    .where('streak', '>', 0)
    .where('notifications.lastStreakReminder', '!=', today)
    .limit(500)
    .get();
  
  for (const doc of users.docs) {
    const user = doc.data();
    if (!user.fcmToken) continue;
    
    await admin.messaging().send({
      token: user.fcmToken,
      notification: {
        title: '‡∏•‡∏∑‡∏° log ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤?',
        body: 'Streak ‡∏à‡∏∞‡∏´‡∏≤‡∏¢! üî• Daily reward ‡∏£‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà',
      },
      data: { type: 'streak_reminder' },
    });
    
    await doc.ref.update({
      'notifications.lastStreakReminder': today,
    });
  }
});
```

**Decision points:**
- Batch size: 100 ‡∏´‡∏£‡∏∑‡∏≠ 500 users/loop? (‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö FCM rate limit)
- Retry: ‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (invalid token) ‚Üí ‡∏•‡∏ö fcmToken ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ?
- Timezone: ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ scheduled function ‡πÉ‡∏ä‡πâ UTC+7

**Output:**
- ‚úÖ `functions/src/notifications/pushTriggers.ts` (3 scheduled functions)
- ‚úÖ Test: mock Firestore queries + FCM send
- ‚úÖ Monitoring: Cloud Functions logs + FCM delivery reports
- ‚úÖ Error handling: invalid token ‚Üí ‡∏•‡∏ö fcmToken

**Timeline:** 1 ‡∏ß‡∏±‡∏ô

---

## Phase 2: Code Review & Integration (‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà 3-7)

### S7. Code Review Framework ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥

**‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**
1. ‡∏™‡∏£‡πâ‡∏≤‡∏á PR template:
   ```markdown
   ## ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
   - [ ] Backend API endpoint ‡πÉ‡∏´‡∏°‡πà
   - [ ] Frontend UI
   - [ ] Database schema
   
   ## Testing
   - [ ] Unit tests passed
   - [ ] Manual testing: [‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå]
   - [ ] Edge cases tested
   
   ## Security
   - [ ] Server-side validation
   - [ ] Rate limiting
   - [ ] Input sanitization
   ```

2. Review checklist ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ task:
   - **Backend:** Server-side validation, error handling, logging, transaction atomicity
   - **Frontend:** Loading state, error state, empty state, offline handling
   - **IAP:** Duplicate purchase prevention, retry mechanism, receipt validation
   - **Firestore:** Index creation, compound queries optimization, security rules
   - **Quest Bar:** Countdown accuracy, offer priority logic, dismissed state persistence

3. Integration testing scenarios:
   - Offer flow: Milestone ‚Üí Offer trigger ‚Üí Purchase ‚Üí Verify ‚Üí Next offer
   - Daily claim: Claim ‚Üí Confetti ‚Üí Tier up ‚Üí Push notification
   - Rewarded ads: Ad view ‚Üí Verify ‚Üí Free AI ‚Üí Quota check
   - **Quest Bar:**
     - ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ ‚Üí Quest Bar ‡πÅ‡∏™‡∏î‡∏á active offer (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
     - Countdown timer update ‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
     - Swipe dismiss ‚Üí Snackbar ‡∏õ‡∏£‡∏≤‡∏Å‡∏è + offer ‡∏´‡∏≤‡∏¢
     - ‡∏Å‡∏î Claim ‚Üí API called ‚Üí UI update
     - Offer expired ‚Üí Quest Bar switch to Streak mode

---

### S8. Quest Bar Integration Testing ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥

**‡πÑ‡∏ü‡∏•‡πå:** `test/integration/quest_bar_test.dart`

**‡∏ï‡πâ‡∏≠‡∏á test:**

1. **Offer Display:**
   ```dart
   test('Quest Bar displays active offer when available', () async {
     // Mock: user has first purchase offer
     await mockUserWithOffer('first_purchase', expiry: 4.hours);
     
     // Open app
     await tester.pumpWidget(MyApp());
     await tester.pumpAndSettle();
     
     // Verify: Quest Bar shows offer
     expect(find.text('üî• 200E ‡πÅ‡∏Ñ‡πà \$1!'), findsOneWidget);
     expect(find.textContaining('‚è∞ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤'), findsOneWidget);
   });
   ```

2. **Countdown Timer:**
   ```dart
   test('Countdown timer updates every second', () async {
     await mockUserWithOffer('first_purchase', expiry: 10.seconds);
     
     await tester.pumpWidget(MyApp());
     await tester.pump(Duration(seconds: 1));
     
     // Time should decrease
     expect(find.textContaining('00:00:09'), findsOneWidget);
     
     await tester.pump(Duration(seconds: 9));
     
     // Offer should disappear after expiry
     expect(find.text('üî• 200E ‡πÅ‡∏Ñ‡πà \$1!'), findsNothing);
     expect(find.textContaining('Streak'), findsOneWidget);
   });
   ```

3. **Swipe to Dismiss:**
   ```dart
   test('Swipe left dismisses offer and shows Snackbar', () async {
     await mockUserWithOffer('first_purchase');
     
     await tester.pumpWidget(MyApp());
     await tester.pumpAndSettle();
     
     // Swipe left
     await tester.drag(find.text('üî• 200E ‡πÅ‡∏Ñ‡πà \$1!'), Offset(-300, 0));
     await tester.pumpAndSettle();
     
     // Verify: offer hidden + Snackbar shown
     expect(find.text('üî• 200E ‡πÅ‡∏Ñ‡πà \$1!'), findsNothing);
     expect(find.text('Offer ‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô'), findsOneWidget);
     expect(find.text('‡∏î‡∏π Offer'), findsOneWidget);
   });
   ```

4. **Claim Button:**
   ```dart
   test('Claim button calls API and shows confetti', () async {
     await mockUserCanClaim(energy: 2);
     
     await tester.pumpWidget(MyApp());
     await tester.pumpAndSettle();
     
     // Tap claim button
     await tester.tap(find.text('+2E'));
     await tester.pump();
     
     // Verify: loading state
     expect(find.byType(CircularProgressIndicator), findsOneWidget);
     
     await tester.pumpAndSettle();
     
     // Verify: confetti + snackbar
     expect(find.byType(ConfettiWidget), findsOneWidget);
     expect(find.textContaining('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö +2E'), findsOneWidget);
   });
   ```

5. **Multiple Offers Priority:**
   ```dart
   test('Quest Bar shows highest priority offer first', () async {
     await mockUserWithOffers([
       { type: 'tier_promo', priority: 3 },
       { type: 'first_purchase', priority: 1 },
       { type: 'bonus_40', priority: 2 },
     ]);
     
     await tester.pumpWidget(MyApp());
     await tester.pumpAndSettle();
     
     // Verify: first_purchase (priority 1) is shown
     expect(find.text('üî• 200E ‡πÅ‡∏Ñ‡πà \$1!'), findsOneWidget);
     
     // Swipe to dismiss
     await tester.drag(find.text('üî• 200E ‡πÅ‡∏Ñ‡πà \$1!'), Offset(-300, 0));
     await tester.pumpAndSettle();
     
     // Verify: bonus_40 (priority 2) is now shown
     expect(find.textContaining('40% Bonus'), findsOneWidget);
   });
   ```

**Timeline:** 1 ‡∏ß‡∏±‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏´‡∏•‡∏±‡∏á S3 Offer System ‡πÄ‡∏™‡∏£‡πá‡∏à)

---

### S9. Performance Optimization ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥

**‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**
1. **Firestore queries:**
   - ‡∏™‡∏£‡πâ‡∏≤‡∏á composite indexes ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (auto-generated ‡∏à‡∏≤‡∏Å error logs)
   - ‡πÉ‡∏ä‡πâ `limit()` ‡∏ó‡∏∏‡∏Å query ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
   - Cache user document ‡πÉ‡∏ô memory (‡∏ñ‡πâ‡∏≤ read ‡∏ö‡πà‡∏≠‡∏¢)
   - **Quest Bar:** Cache `activeOffers` ‡πÉ‡∏ô local state (refresh ‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ)

2. **Firebase Functions cold start:**
   - ‡πÉ‡∏ä‡πâ `minInstances: 1` ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö critical endpoints:
     - `verifyPurchase`
     - `analyzeFood`
     - `getActiveOffers` (üî¥ CRITICAL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Quest Bar)
   - ‡πÅ‡∏¢‡∏Å functions ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏±‡∏ô (‡πÑ‡∏°‡πà import ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô index.ts)

3. **Frontend:**
   - Quest Bar: preload active offers ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ (‡πÉ‡∏ä‡πâ `FutureProvider`)
   - Rewarded ads: preload ad ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏ô (‡∏•‡∏î wait time)
   - Confetti animation: ‡πÉ‡∏ä‡πâ Lottie ‡πÅ‡∏ó‡∏ô custom animation (performance ‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤)
   - **Countdown timer:** ‡πÉ‡∏ä‡πâ `Timer` ‡πÅ‡∏ó‡∏ô `StreamBuilder` (‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î CPU)

**Quest Bar Performance Targets:**
- Load time: < 500ms (measure with Firebase Performance Monitoring)
- Memory: < 50MB (profile with Dart DevTools)
- Countdown update: 60 fps (smooth animation)

**Output:**
- Performance benchmark report
- Firebase Performance traces enabled
- Memory profiling results

---

### S10. Security Audit ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥

**‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ:**

**1. Server-side validation ‡∏ó‡∏∏‡∏Å purchase/claim endpoint:**
```typescript
// ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÉ‡∏ô verifyPurchase.ts
if (!deviceId || !productId || !purchaseToken) {
  throw new Error('Missing required parameters');
}

// ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÉ‡∏ô claimDailyEnergy.ts
const lastClaimDate = userData.dailyClaim?.lastClaimDate;
if (lastClaimDate === today) {
  throw new Error('Already claimed today');
}
```

**2. Rate limiting:**
- Rewarded ads: max 3/day ‚Üí check `adViews.count` before verify
- Daily claim: max 1/day ‚Üí check `dailyClaim.lastClaimDate`
- Offer claim: 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‚Üí check `offers.${offerType}Claimed`
- **API rate limit:** ‡πÉ‡∏ä‡πâ Firebase App Check (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô bot)

**3. Firestore security rules:**
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // users collection
    match /users/{deviceId} {
      // Read: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ user ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠ authenticated
      allow read: if request.auth != null && request.auth.uid == deviceId;
      
      // Write: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Cloud Functions (‡∏´‡πâ‡∏≤‡∏° client write)
      allow write: if false;
    }
    
    // transactions collection
    match /transactions/{transactionId} {
      // Read: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ user ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á transaction
      allow read: if request.auth != null && 
                     resource.data.deviceId == request.auth.uid;
      
      // Write: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Cloud Functions
      allow write: if false;
    }
  }
}
```

**4. Secret management:**
- ‚úÖ Google Service Account JSON ‚Üí Cloud Secret Manager
- ‚úÖ AdMob App ID ‚Üí Environment variables
- ‚úÖ IAP Product IDs ‚Üí Constants (‡πÑ‡∏°‡πà sensitive)
- ‚ùå ‡∏´‡πâ‡∏≤‡∏° hardcode secrets ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î

**5. Input validation & sanitization:**
```typescript
// Validate deviceId format
function isValidDeviceId(deviceId: string): boolean {
  return /^[a-zA-Z0-9_-]{10,50}$/.test(deviceId);
}

// Sanitize productId (whitelist)
const VALID_PRODUCT_IDS = [
  'energy_100',
  'energy_550',
  'energy_1200',
  'energy_2000',
  'energy_200_first_purchase',
  // ...
];

function isValidProductId(productId: string): boolean {
  return VALID_PRODUCT_IDS.includes(productId);
}
```

**6. Quest Bar Security:**
- ‚úÖ Offer expiry: check server-side (‡πÑ‡∏°‡πà trust client time)
- ‚úÖ Dismissed offers: ‡πÄ‡∏Å‡πá‡∏ö state ‡πÉ‡∏ô local (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å server ‚Üí ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô spam)
- ‚úÖ Countdown timer: ‡πÉ‡∏ä‡πâ server time ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å

**Output:**
- ‚úÖ Security checklist (‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡∏ï‡πâ‡∏≠‡∏á pass)
- ‚úÖ Firestore rules deployed
- ‚úÖ Firebase App Check enabled
- ‚úÖ Security audit report

**Timeline:** 1 ‡∏ß‡∏±‡∏ô

---

### S11. Migration & Rollout Plan ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥

**‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**

**1. Backward compatibility:**

**Migration Strategy:**
```typescript
// scripts/migrateUsersToV3.ts

async function migrateUser(deviceId: string) {
  const userRef = db.collection('users').doc(deviceId);
  const userData = (await userRef.get()).data();
  
  // 1. Migrate Milestones
  const oldTotalSpent = userData.milestones?.totalSpent || 0;
  const { claimedMilestones, nextMilestoneIndex } = computeMilestoneState(oldTotalSpent);
  
  // 2. Initialize new fields (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
  const updates: any = {
    'offers.firstPurchaseClaimed': userData.offers?.firstPurchaseClaimed || false,
    'offers.firstPurchaseAvailable': false, // default
    'offers.firstPurchaseExpiry': null,
    
    'offers.welcomeBonusClaimed': userData.offers?.welcomeBonusClaimed || false,
    'offers.welcomeBonusAvailable': false,
    'offers.welcomeBonusExpiry': null,
    
    'offers.tierPromoClaimed': userData.offers?.tierPromoClaimed || {
      bronze: false,
      silver: false,
      gold: false,
      diamond: false,
    },
    'offers.tierPromoActive': { tier: null, expiry: null },
    
    'milestones.claimedMilestones': claimedMilestones,
    'milestones.nextMilestoneIndex': nextMilestoneIndex,
    
    'adViews': userData.adViews || { date: '', count: 0 },
    
    'dailyClaim': userData.dailyClaim || {
      lastClaimDate: '',
      canClaim: false,
    },
    
    'notifications': userData.notifications || {
      offerExpirySent: {},
      lastStreakReminder: '',
    },
  };
  
  await userRef.update(updates);
  console.log(`‚úÖ Migrated user: ${deviceId}`);
}

// Batch migration (100 users at a time)
async function migrateAllUsers() {
  let lastDoc = null;
  let totalMigrated = 0;
  
  while (true) {
    let query = db.collection('users').orderBy('lastUpdated').limit(100);
    
    if (lastDoc) {
      query = query.startAfter(lastDoc);
    }
    
    const snapshot = await query.get();
    
    if (snapshot.empty) break;
    
    for (const doc of snapshot.docs) {
      try {
        await migrateUser(doc.id);
        totalMigrated++;
      } catch (error) {
        console.error(`‚ùå Failed to migrate ${doc.id}:`, error);
      }
    }
    
    lastDoc = snapshot.docs[snapshot.docs.length - 1];
    console.log(`Migrated ${totalMigrated} users so far...`);
    
    // Rate limit (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Firestore overload)
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
  
  console.log(`‚úÖ Migration complete! Total: ${totalMigrated} users`);
}
```

**2. Staged rollout:**

**Phase 1: Deploy backend (Day 1-2)**
```bash
# Deploy functions (backward compatible)
firebase deploy --only functions:getActiveOffers
firebase deploy --only functions:claimDailyEnergy
firebase deploy --only functions:verifyRewardedAd

# Run migration script
npm run migrate:v3

# Verify: check 10 random users
```

**Phase 2: Deploy frontend ‚Üí 10% users (Day 3-5)**
```yaml
# Firebase Remote Config
quest_bar_enabled:
  defaultValue: false
  conditionalValues:
    - condition: "10% rollout"
      value: true
```

**Phase 3: Monitor 2-3 ‡∏ß‡∏±‡∏ô (Day 6-8)**
- Crash rate: < 0.5%
- Quest Bar load time: < 500ms (p95)
- Conversion rate: $1 offer > 5%
- User feedback: check reviews

**Phase 4: 100% rollout (Day 9+)**
```yaml
quest_bar_enabled:
  defaultValue: true
```

**3. Rollback plan:**

**Option A: Feature flags (Recommended)**
```dart
// lib/features/energy/widgets/quest_bar.dart

final questBarEnabled = RemoteConfig.instance.getBool('quest_bar_enabled');

if (questBarEnabled) {
  return QuestBar();
} else {
  return const SizedBox.shrink(); // ‡∏ã‡πà‡∏≠‡∏ô Quest Bar
}
```

**Option B: App version rollback**
- Force update ‚Üí version ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
- Database: ‡πÑ‡∏°‡πà‡∏•‡∏ö field ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö rollback)

**Output:**
- ‚úÖ Migration script: `scripts/migrateUsersToV3.ts`
- ‚úÖ Rollback script: `scripts/rollbackV3.ts`
- ‚úÖ Monitoring dashboard: Firebase Console + Grafana
- ‚úÖ Rollout checklist

**Timeline:** 9-10 ‡∏ß‡∏±‡∏ô (‡∏£‡∏ß‡∏° monitoring)

---

## ‡∏™‡∏£‡∏∏‡∏õ Timeline (Senior) ‚Äî ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï 20 ‡∏Å.‡∏û. 2026

| ‡∏á‡∏≤‡∏ô | ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ | Output |
|-----|-------|--------|
| S0 Quest Bar Widget | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à | Quest Bar Widget ‡πÉ‡∏ô Timeline |
| S1 Firestore Schema | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à | `_docs/FIRESTORE_SCHEMA_V3.md` |
| S2 Milestone V2 | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à | `milestoneV2.ts` ‚Äî 10 ‡∏Ç‡∏±‡πâ‡∏ô |
| S3 Offer System | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à | `offersV2.ts` ‚Äî getActiveOffers API |
| S4 Bug Fix ‡∏ã‡∏∑‡πâ‡∏≠‡∏ã‡πâ‡∏≥ | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à | `verifyPurchase.ts` + `promotions.ts` |
| S5 Rewarded Ads SSV | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à | `rewardedAd.ts` ‚Äî SSV verification |
| S6 Push Notifications | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à | `pushTriggers.ts` ‚Äî 3 triggers |
| S7 Code Review | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à | PR template + checklist |
| S8 Quest Bar Tests | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à | Integration tests |
| S9 Performance | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à | Optimization guide |
| S10 Security Audit | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à | Security checklist + Firestore rules |
| S11 Migration | ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à | Migration scripts + Rollout plan |

### üéâ ‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß! (12/12 tasks = 100%)
- ‚úÖ S0-S6: Architecture, Schema, Backend APIs, Bug fixes ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
- ‚úÖ S7-S11: Code Review, Testing, Performance, Security, Migration
- ‚úÖ Junior tasks (J1-J18) ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß
- ‚úÖ **‡∏û‡∏£‡πâ‡∏≠‡∏° Deploy Production!**
